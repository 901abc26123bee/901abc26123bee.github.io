---
title: Docker volumes Problem onUbuntu on WSL2
date: 2023-09-10 00:29:48
categories: Docker
tags:
 - Docker
 - WSL2
---

## Docker Volume type

[Manage data in Docker](https://docs.docker.com/storage/)

- bind mounts :

  When you use a bind mount, a file or directory on the host machine is mounted into a container. They rely on the host machine’s filesystem having a specific directory structure available.
  ```
  volumes:
    — /mnt/c/work/db:/var/lib/mysql”
  --> manipulate data in /mnt/c/work/db on Ubuntu on WSL == manipulate data /var/lib/mysql in docker volume
  ```
- volumes :
  [volumes](https://docs.docker.com/storage/)
<!--more-->


  Volumes are stored in a part of the host filesystem which is managed by Docker (`/var/lib/docker/volumes/` on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.

  When you create a volume, it is stored within a directory on the Docker host. When you mount the volume into a container, this directory is what is mounted into the container. This is similar to the way that bind mounts work, except that volumes are managed by Docker and are isolated from the core functionality of the host machine.

## File permission problem :

<img src="./1.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">


When you use bind mounts for persisting data in generated by and used by Docker containers on Ubuntu on WSL2, you may encounter file permission problems.


- docker-compose.yaml

  ```yaml
  services:
    # ...
    db_mysql:
      build:
        context: ./db_context
        dockerfile: Dockerfile-db-mysql
      env_file: .env
      volumes:
        - "${DB_DATA_PATH_MYSQL}:/var/lib/mysql"
      command:  --transaction-isolation=READ-COMMITTED --socket=/tmp/mysql.sock --sql_mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
      ports:
        - 3316:3306
      networks:
        docker_network:
          ipv4_address: 172.16.238.6
      container_name: db_mysql
  ```

- Dockerfile-db_mysql

  ```yaml
  FROM mysql:8.0
  COPY my.cnf /etc/mysql/conf.d/
  ```

- .evn
  ```
  DB_DATA_PATH_MYSQL=/mnt/c/work/db
  MYSQL_ROOT_PASSWORD=123456
  MYSQL_USER=test
  MYSQL_PASSWORD=test123
  ```

- Error log like:
  ```
  mysqld: Can't change permissions of the file 'ca-key.pem' (Errcode: 1 - Operation not permitted)
  2022-03-25T05:32:05.406540Z 0 [ERROR] Could not set file permission for ca-key.pem
  2022-03-25T05:32:05.406553Z 0 [ERROR] Aborting
  2022-03-04T02:58:39.130160Z 0 [ERROR] [MY-010295] [Server] Could not set file permission for ca.pem
  2022-03-04T02:58:39.130213Z 0 [ERROR] [MY-013236] [Server] The designated data directory /var/lib/mysql/ is unusable. You can remove all files that the server added to it.
  ```

These problems are caused by sharing files permission across the Windows Subsystem for Linux (WSL) and Window. Windows file systems differ substantially from Linux file systems. WSL use a filesystem plugin DrvFs to support interop between WSL and the Windows filesystem.

> [MicrosoftDocs/WSLPublic](https://github.com/MicrosoftDocs/wsl/blob/main/WSL/wsl-config.md)
  [Chmod/Chown WSL Improvements](https://devblogs.microsoft.com/commandline/chmod-chown-wsl-improvements/)
  [WSL File System Support](https://learn.microsoft.com/zh-tw/archive/blogs/wsl/wsl-file-system-support)
  **DrvFs**
    To facilitate interoperability with Windows, WSL uses the DrvFs file system. WSL automatically mounts all fixed drives with supported file systems under /mnt, such as /mnt/c, /mnt/d, etc. Currently, only NTFS and ReFS volumes are supported.
    (window) C:\work\db ← → (WSL) /mnt/c/work/db

### Solution 1 : volume
<img src="./2.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">


Use volumes which are completely managed by Docker to solve this problem.

```yaml
services:
  # ...
  db_mysql:
    build:
      context: ./db_context
      dockerfile: Dockerfile-db-mysql
    env_file: .env
    volumes:
      - "${DB_DATA_PATH_MYSQL}:/var/lib/mysql"
    command:  --transaction-isolation=READ-COMMITTED --socket=/tmp/mysql.sock --sql_mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
    ports:
      - 3316:3306
    networks:
      docker_network:
        ipv4_address: 172.16.238.6
    container_name: db_mysql
volumes:
 mysql:
```

WSL2 Ubuntu
```sh
$ docker-compose up build
$ docker exec -it db_mysql bash
root@fdg453:/# mysql -h 127.0.0.1 -u test -p
Enter password : test123
mysql>
```

Also, you may encounter other problems likes :
```
mysqld: [Warning] World-writable config file '/etc/mysql/conf.d/my.cnf' is ignored.
```

After mount file systems into WSL2 from Window, my.cnf file permissions were changed to 777 from 744. Docker daemon copies files from the host to the container verbatim, inluding numeric user ids, resulting inmy.cnfwith file permissions 777 in docker container. Mysql’s security mechanism ignores the file because of insecure read and write permissions. We need to change permissions of `my.cnf`.

Consider below methods to fix:

1. Chmod in DockerFile : [Fixing World-writable MySql error in Docker, HANDLING PERMISSIONS WITH DOCKER VOLUMES](https://denibertovic.com/posts/handling-permissions-with-docker-volumes/)
2. Modified file permissions on host before Docker daemon copy it into container.

Modified file permissions for target file on WSL2 ubuntu

```sh
/mnt/c/work/db_context# ls -al
total 0
drwxrwxrwx 1 xxx xxx 512 Mar 25 16:20 .
drwxrwxrwx 1 xxx xxx 512 Mar 28 12:12 ..
-rwxrwxrwx 1 xxx xxx  49 Mar 25 16:20 Dockerfile-db-mysql
-rw-r--r-- 1 xxx xxx 389 Mar 17 11:28 my.cnf
/mnt/c/work/db_context# chmod 644 my.cnf
/mnt/c/work/db_context# ls -al
total 0
drwxrwxrwx 1 xxx xxx 512 Mar 25 16:20 .
drwxrwxrwx 1 xxx xxx 512 Mar 28 12:12 ..
-rwxrwxrwx 1 xxx xxx  49 Mar 25 16:20 Dockerfile-db-mysql
-rw-r--r-- 1 xxx xxx 389 Mar 17 11:28 my.cnf
```


### Solution 2 : bind mount + wsl.conf
<img src="./3.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">

Add wsl.conf with metadataautomount options to support Linux system permissions in WSL2.(MicrosoftDocs/WSLPublic)

WSL2 ubuntu
```sh
# login root
$ sudo -i
$ cd /etc/
# create wsl.conf
$ vim wsl.conf
```

wsl.conf
```conf
[automount]
options = "metadata"
```

restart WSL2 (Using PowerShell)
```sh
$ wsl --shutdown
$ wsl
# start docker
$ service docker start
# restart your mysql project
$ docker-compose up
```