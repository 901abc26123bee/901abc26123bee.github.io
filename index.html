<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="FatCat">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="FatCat">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="WongJY">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-tw'
  };
</script>

  <title>FatCat</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">FatCat</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/20/Golang-CSP-Channel-And-Gorutine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/20/Golang-CSP-Channel-And-Gorutine/" class="post-title-link" itemprop="url">Golang CSP: Channel And Gorutine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-20 23:56:24" itemprop="dateCreated datePublished" datetime="2023-12-20T23:56:24+08:00">2023-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 00:07:06" itemprop="dateModified" datetime="2023-12-21T00:07:06+08:00">2023-12-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Golang-CSP-Channel-And-Gorutine"><a href="#Golang-CSP-Channel-And-Gorutine" class="headerlink" title="Golang CSP: Channel And Gorutine"></a>Golang CSP: Channel And Gorutine</h1><p>In Go (Golang), channels and goroutines are key components of the language’s concurrency model, which is inspired by Communicating Sequential Processes (CSP). CSP is a formal language for describing patterns of interaction in concurrent systems. The main ideas of CSP include processes communicating by sending and receiving messages over channels, and synchronization through communication rather than through shared memory.<br>Channels in Go are a communication mechanism designed to allow one goroutine to safely send data to another goroutine in concurrent or multi-goroutine scenarios.</p>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
</blockquote>
<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/runtime/chan.go">chan.go</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">	qcount   <span class="keyword">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">	dataqsiz <span class="keyword">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">	buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">	elemsize <span class="keyword">uint16</span></span><br><span class="line">	closed   <span class="keyword">uint32</span></span><br><span class="line">	elemtype *_type <span class="comment">// element type</span></span><br><span class="line">	sendx    <span class="keyword">uint</span>   <span class="comment">// send index</span></span><br><span class="line">	recvx    <span class="keyword">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">	recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">	sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line">	lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2023/12/20/Golang-CSP-Channel-And-Gorutine/channel_structure.jpg" width="100%" height="100%" title="image" alt="channel_structure">


<h3 id="UnBuffered-Channels"><a href="#UnBuffered-Channels" class="headerlink" title="UnBuffered Channels"></a>UnBuffered Channels</h3><p>By default channels are unbuffered, meaning that they will only accept sends (chan &lt;-) if there is a corresponding receive (&lt;- chan) ready to receive the sent value. It enforces a synchronous communication between the two goroutines involved in the communication</p>
<ol>
<li>The producers and consumers of a channel appear in pairs, but both within the same goroutine. <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  c &lt;- <span class="string">&quot;hello&quot;</span> <span class="comment">// block for ever</span></span><br><span class="line">  msg := &lt;-c</span><br><span class="line">  fmt.Println(msg)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line"><span class="comment">goroutine 1 [chan send]:</span></span><br><span class="line"><span class="comment">main.main()</span></span><br><span class="line"><span class="comment">  /tmp/sandbox3222265902/prog.go:9 +0x36</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li><p>The producers and consumers of a channel operate in pairs but within different goroutines.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ms := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;hello&quot;</span></span><br><span class="line">  &#125;(ms)</span><br><span class="line">  msg := &lt;-ms</span><br><span class="line">  fmt.Println(msg)  <span class="comment">// hello</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unbuffered channels are useful in scenarios where synchronization between two goroutines since it ensure that the sender and receiver are ready to communicate at the same time.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  dog  = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  cat  = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  fish = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  wg   sync.WaitGroup</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Dog</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-dog</span><br><span class="line">  fmt.Println(<span class="string">&quot;dog&quot;</span>)</span><br><span class="line">  cat &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cat</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-cat</span><br><span class="line">  fmt.Println(<span class="string">&quot;cat&quot;</span>)</span><br><span class="line">  fish &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fish</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-fish</span><br><span class="line">  fmt.Println(<span class="string">&quot;fish&quot;</span>)</span><br><span class="line">  dog &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    wg.Add(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Dog()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Cat()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Fish()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start the cycle</span></span><br><span class="line">  dog &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A fatal error occurred at the end of the process due to the absence of any receiver for the last message sent on the unbuffered channel &#x27;fish&#x27;.</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">dog</span></span><br><span class="line"><span class="comment">cat</span></span><br><span class="line"><span class="comment">fish</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">dog</span></span><br><span class="line"><span class="comment">cat</span></span><br><span class="line"><span class="comment">fish</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="4">
<li>In some scenarios like timeout control, may lead to memory leak.<ul>
<li>If there is no timeout, <code>doLongTask</code> signals the unbuffered channel <code>done</code>, and the <code>select</code> statement receives the signal. Consequently, <code>doLongTask</code> and the child coroutine can exit gracefully.</li>
<li>When a timeout occurs, the <code>select</code> statement receives the timeout signal from <code>time.After</code> and returns. Since unbuffered channel <code>done</code> has no receiver at this point, and <code>doLongTask</code> sends a signal to channel <code>done</code> after 1 second of execution, the sender will be blocked indefinitely due to the lack of a receiver and no buffer, preventing the coroutine from exiting.<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doLongTask</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  time.Sleep(time.Second) <span class="comment">// long task</span></span><br><span class="line">  done &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeout</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">  done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>) <span class="comment">// unbuffered channel</span></span><br><span class="line">  <span class="keyword">go</span> f(done)</span><br><span class="line">  <span class="comment">// If there is no default statement in the select statement, it will block and wait for any of the case statements.</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-done:</span><br><span class="line">    fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond):</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDoLongTask</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    timeout(doLongTask)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">  t.Log(runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">=== RUN   TestDoLongTask</span></span><br><span class="line"><span class="comment">    prog_test.go:38: 1002</span></span><br><span class="line"><span class="comment">--- PASS: TestDoLongTask (3.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ol>
<h3 id="Buffered-Channels"><a href="#Buffered-Channels" class="headerlink" title="Buffered Channels"></a>Buffered Channels</h3><p>Golang provides buffered channels, which allow you to specify a fixed length of buffer capacity so one can send that number of data values at once. These channels are only blocked when the buffer is full.</p>
<ol>
<li>To prevent memory leaks, utilize buffered channels to avoid the sender from being blocked, even in the absence of a receiver. <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doLongTask</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  time.Sleep(time.Second) <span class="comment">// long task</span></span><br><span class="line">  done &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeout</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">  done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>) <span class="comment">// buffered channel</span></span><br><span class="line">  <span class="keyword">go</span> f(done)</span><br><span class="line">  <span class="comment">// If there is no default statement in the select statement, it will block and wait for any of the case statements.</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-done:</span><br><span class="line">    fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond):</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDoLongTask</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    timeout(doLongTask)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">  t.Log(runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">=== RUN   TestBufferTimeout</span></span><br><span class="line"><span class="comment">    prog_test.go:34: 2</span></span><br><span class="line"><span class="comment">--- PASS: TestBufferTimeout (3.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="Select-Statement"><a href="#Select-Statement" class="headerlink" title="Select Statement"></a>Select Statement</h3><p><code>select</code> statement is used to deal with multiple communication operations. It allows a goroutine to wait on multiple communication operations and proceed as soon as one of them can proceed. This is particularly useful when working with channels to handle concurrent communication and synchronization.<br>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  taskCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage started...&quot;</span>)</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage ending...&quot;</span>)</span><br><span class="line">    <span class="built_in">close</span>(taskCh)</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait for the first segment of a task to complete or timeout using the select statement</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-taskCh:</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage completed. Continuing with the next stages...&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;Timeout occurred. Aborting further stages.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">&quot;Second stage started...&quot;</span>)</span><br><span class="line">  time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">  fmt.Println(<span class="string">&quot;Second stage ending...&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/runtime/select.go#L121">selectgo</a></p>
<ol>
<li>The select statement in Go is a specialized statement used exclusively for sending and receiving messages on channels. This statement is blocking during execution. When there is no case statement in the select, it will block the current goroutine.</li>
<li>select is Go’s language-level mechanism for I/O multiplexing. It is specifically designed to detect whether multiple channels are ready: either for reading or writing.</li>
<li>In the select statement, except for default, each case operates on a single channel, either for reading or writing.</li>
<li>In the select statement, except for default, the execution order of each case is random.</li>
<li>If there is no default statement in the select statement, it will block and wait for any of the case statements.</li>
<li>In the select statement, when performing a read operation, it is necessary to check whether the read was successful. Closed channels can also be read in the select statement.</li>
</ol>
<h3 id="Channel-Operations"><a href="#Channel-Operations" class="headerlink" title="Channel Operations"></a>Channel Operations</h3><h4 id="1-Sending-Data-chan-lt"><a href="#1-Sending-Data-chan-lt" class="headerlink" title="1. Sending Data (chan &lt;-)"></a>1. Sending Data (chan &lt;-)</h4><ul>
<li>If the receiving queue (recvq) is not empty, it signifies an absence of data in the buffer or the absence of a buffer. In such a scenario, retrieve a Goroutine (G) from recvq, write the data, awaken G, and conclude the sending process.</li>
<li>If there is space available in the buffer, write the data into the buffer, concluding the sending process.</li>
<li>If the buffer has no available space, write the data to be sent into G, add the current G to the sending queue (sendq), enter a sleep state, and await awakening by a reading</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Send to a closed channel cause panic **</span></span><br><span class="line">  <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Dequeuing from Receiver Queue **</span></span><br><span class="line">  <span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// Found a waiting receiver. We pass the value we want to send</span></span><br><span class="line">    <span class="comment">// directly to the receiver, bypassing the channel buffer (if any).</span></span><br><span class="line">    send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Enqueuing to Channel Buffer **</span></span><br><span class="line">  <span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">    <span class="comment">// Space is available in the channel buffer. Enqueue the element to send.</span></span><br><span class="line">    qp := chanbuf(c, c.sendx)</span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">      racenotify(c, c.sendx, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">    c.sendx++</span><br><span class="line">    <span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">      c.sendx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.qcount++</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Block on the channel if is allowed, it then enqueues the current goroutine(mysg) to the send queue (c.sendq) and parks the goroutine (gopark). This means the goroutine will be put to sleep until a receiver completes the operation. **</span></span><br><span class="line">  gp := getg()</span><br><span class="line">  mysg := acquireSudog()</span><br><span class="line">  mysg.releasetime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  gp.waiting = mysg</span><br><span class="line">  gp.param = <span class="literal">nil</span></span><br><span class="line">  c.sendq.enqueue(mysg)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ** Ensure the value being sent is kept alive until the receiver copies it out. **</span></span><br><span class="line">  KeepAlive(ep)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// someone woke us up.</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-Receiving-Data-lt-chan"><a href="#2-Receiving-Data-lt-chan" class="headerlink" title="2. Receiving Data (&lt;- chan)"></a>2. Receiving Data (&lt;- chan)</h4><ul>
<li>If the waiting sending queue (sendq) is not empty and there is no buffer, directly retrieve a Goroutine (G) from sendq,  wake up G, end the reading process.</li>
<li>If the waiting sending queue (sendq) is not empty, indicating that the buffer is full, read data from the head of the buffer, write the data from G to the end of the buffer, wake up G, and  end the reading process.</li>
<li>If there is data in the buffer, retrieve the data from the buffer and end the reading process</li>
<li>If the waiting sending queue (sendq) and buffer are empty, add the current Goroutine to recvq, enter a sleep state, and await awakening by a writing Goroutine.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Read from a closed channel is allowed **</span></span><br><span class="line">  <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.qcount == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        raceacquire(c.raceaddr())</span><br><span class="line">      &#125;</span><br><span class="line">      unlock(&amp;c.lock)</span><br><span class="line">      <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">        typedmemclr(c.elemtype, ep)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The channel has been closed, but the channel&#x27;s buffer have data.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Just found waiting sender with not closed.</span></span><br><span class="line">    <span class="keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// Found a waiting sender. If buffer is size 0, receive value</span></span><br><span class="line">      <span class="comment">// directly from sender. Otherwise, receive from head of queue</span></span><br><span class="line">      <span class="comment">// and add sender&#x27;s value to the tail of the queue (both map to</span></span><br><span class="line">      <span class="comment">// the same buffer slot because the queue is full).</span></span><br><span class="line">      recv(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Dequeuing from Channel Buffer **</span></span><br><span class="line">  <span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// Receive directly from queue</span></span><br><span class="line">    qp := chanbuf(c, c.recvx)</span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">      racenotify(c, c.recvx, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">      typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">    &#125;</span><br><span class="line">    typedmemclr(c.elemtype, qp)</span><br><span class="line">    c.recvx++</span><br><span class="line">    <span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">      c.recvx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.qcount--</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// no sender available: block on this channel.</span></span><br><span class="line">  gp := getg()</span><br><span class="line">  mysg := acquireSudog()</span><br><span class="line">  mysg.releasetime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  gp.waiting = mysg</span><br><span class="line">  gp.param = <span class="literal">nil</span></span><br><span class="line">  c.recvq.enqueue(mysg)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// someone woke us up</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>, success</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-Close-channel"><a href="#3-Close-channel" class="headerlink" title="3. Close channel"></a>3. Close channel</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">operation         | nil channel | closed channel     |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">close(ch)         | panic       | panic              |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">ch &lt;-             | blocking    | panic              |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">v, ok := &lt;- ch    | blocking    | ok always be <span class="literal">false</span> |</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://go101.org/article/channel-closing.html">How to Gracefully Close Channels</a></p>
<ol>
<li>M receivers, one sender, the sender says “no more sends” by closing the data channel</li>
<li>One receiver, N senders, the only receiver says “please stop sending more” by closing an additional signal channel</li>
<li>M receivers, N senders, any one of them says “let’s end the game” by notifying a moderator to close an additional signal channel</li>
</ol>
<p>Solutions Which Close Channels Politely: Use sync.Once or a mutex (sync.Mutex) to ensure that the channel is closed only once</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyChannel <span class="keyword">struct</span> &#123;</span><br><span class="line">  C    <span class="keyword">chan</span> T</span><br><span class="line">  once sync.Once</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMyChannel</span><span class="params">()</span> *<span class="title">MyChannel</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;MyChannel&#123;C: <span class="built_in">make</span>(<span class="keyword">chan</span> T)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mc *MyChannel)</span> <span class="title">SafeClose</span><span class="params">()</span></span> &#123;</span><br><span class="line">  mc.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">close</span>(mc.C)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/20/Authentication-and-Authorization-for-SSO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/20/Authentication-and-Authorization-for-SSO/" class="post-title-link" itemprop="url">Authentication and Authorization for SSO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-20 23:54:06 / Modified: 23:58:30" itemprop="dateCreated datePublished" datetime="2023-12-20T23:54:06+08:00">2023-12-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Authentication-Authorization/" itemprop="url" rel="index"><span itemprop="name">Authentication, Authorization</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Authentication-and-Authorization-for-SSO"><a href="#Authentication-and-Authorization-for-SSO" class="headerlink" title="Authentication and Authorization for SSO"></a>Authentication and Authorization for SSO</h1><h2 id="OAuth-2-0-Open-Authorization-2-0"><a href="#OAuth-2-0-Open-Authorization-2-0" class="headerlink" title="OAuth 2.0 (Open Authorization 2.0):"></a>OAuth 2.0 (Open Authorization 2.0):</h2><p>  OAuth 2.0 is an <strong>authorization framework</strong> that allows third-party applications to obtain limited access to a user’s resources on a server without exposing their credentials. It’s commonly used for delegated authorization scenarios, such as allowing a third-party application to access a user’s data on another service (e.g., social media data access).<br>  If the Client is a Single-Page App (SPA), an application running in a browser using a scripting language like JavaScript, there are two grant options:</p>
<ul>
<li><p>Authorization code (front channel + back channel): safer since the Access Token is not exposed on the client side, and this flow can return Refresh Tokens.</p>
</li>
<li><p>Implicit (front channel only)</p>
<p><a target="_blank" rel="noopener" href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/which-oauth-2-0-flow-should-i-use">Which OAuth 2.0 Flow Should I Use?</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=996OiexHze0">OAuth 2.0 and OpenID Connect (in plain English)</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/59511628/is-it-secure-to-store-a-refresh-token-in-the-database-to-issue-new-access-toke">Is it secure to store a refresh token in the database?</a></p>
</li>
</ul>
<h2 id="OpenID-Connect-OIDC"><a href="#OpenID-Connect-OIDC" class="headerlink" title="OpenID Connect (OIDC):"></a>OpenID Connect (OIDC):</h2><p>  OpenID Connect is an <strong>interoperable authentication protocol based on the OAuth 2.0 framework</strong> . It provides a standardized way for clients to obtain information about the end-user in order to authenticate them. OIDC is often used for single sign-on (SSO) scenarios, where a user can log in once and access multiple applications without needing to log in again. OIDC uses JSON Web Tokens (JWT), HTTP flows and avoids sharing user credentials with services.</p>
<p>  What OpenID Connect adds</p>
<ul>
<li><p>ID token(JWT)</p>
</li>
<li><p>UserInfo endpoint for getting more user information</p>
</li>
<li><p>Standard set of scopes</p>
</li>
<li><p>Standardized implementation</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------------------</span><br><span class="line">| OpenID Connect |  -&gt; OpenID Connect is <span class="keyword">for</span> authentication</span><br><span class="line">------------------</span><br><span class="line">|    OAuth 2.0   |  -&gt; OAuth 2.0 is <span class="keyword">for</span> authorization</span><br><span class="line">------------------</span><br><span class="line">|      HTTP      |</span><br><span class="line">------------------</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://openid.net/developers/how-connect-works/">How OpenID Connect Works - OpenID Foundation</a></p>
<h2 id="JSON-Web-Tokens-JWT"><a href="#JSON-Web-Tokens-JWT" class="headerlink" title="JSON Web Tokens (JWT):"></a>JSON Web Tokens (JWT):</h2><p>JSON Web Tokens (JWT) are <strong>a format for representing claims</strong>, often used in OAuth 2.0 and OIDC as a means of transmitting information securely between parties. In OIDC, the identity token is a JWT.</p>
<p>JWTs consist of three parts:</p>
</li>
<li><p>Header: typically consists of two parts: the type of the token, which is JWT, and the signing algorithm being used, such as HMAC SHA256 or RSA.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>PlayLoad(claims): there are three types of claims: registered(<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7519#page-10">reference</a>), public(<a target="_blank" rel="noopener" href="https://www.iana.org/assignments/jwt/jwt.xhtml">reference</a>), and private(custom) claims.</p>
</li>
<li><p>Signature: used to verify the message wasn’t changed along the way</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">base64UrlEncode(payload),</span><br><span class="line">secret)</span><br></pre></td></tr></table></figure>

<p>The output is three Base64-URL strings separated by dots.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Base64[Header].Base64[Payload(claims)].Base64[Signature]</span><br></pre></td></tr></table></figure>

<p>usage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jwt.io/introduction">Introduction to JSON Web Tokens</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/16/how-to-troubleshooting-k8s-pods-and-containers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/16/how-to-troubleshooting-k8s-pods-and-containers/" class="post-title-link" itemprop="url">How to troubleshooting k8s pods and containers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-16 17:00:06 / Modified: 17:14:00" itemprop="dateCreated datePublished" datetime="2023-09-16T17:00:06+08:00">2023-09-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernete-Docker/" itemprop="url" rel="index"><span itemprop="name">Kubernete, Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="How-to-troubleshooting-k8s-pods-and-containers"><a href="#How-to-troubleshooting-k8s-pods-and-containers" class="headerlink" title="How to troubleshooting k8s pods and containers"></a>How to troubleshooting k8s pods and containers</h1><h2 id="hold-on-program-by-tail-f-dev-null"><a href="#hold-on-program-by-tail-f-dev-null" class="headerlink" title="hold on program by tail -f /dev/null"></a>hold on program by <code>tail -f /dev/null</code></h2><p>The command “tail -f /dev/null” is a Unix/Linux command that is often used as a placeholder or a trick to prevent a command or a script from exiting or terminating.</p>
<p>The tail command is typically used to display the last few lines of a file. When used with the -f option, it enables “follow” mode, where tail will continuously display new lines appended to the file in real-time. However, when tail -f is used with /dev/null, which is a special file that discards all data written to it, the command essentially does nothing. /dev/null is commonly used as a bit bucket or a sink for unwanted output.</p>
<p>So, in essence, running the command “tail -f /dev/null” will cause the tail command to start and keep running indefinitely, but it won’t display any output because /dev/null discards everything written to it. It’s often used as a placeholder command to prevent scripts or programs from exiting or to keep a terminal session open without any active output.</p>
<h3 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h3><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command: [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">my-image:tag</span></span><br><span class="line">  <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>NOTE<br>  Keep in mind that while ENTRYPOINT defines the default command in dockerfile, it can be overridden by providing commands in the Kubernetes pod. This means that if you specify a command  <code>tail -f /dev/null</code> within the pod, the container within it will be held up by the provided command, and any commands specified in the ENTRYPOINT won’t be executed.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/" class="post-title-link" itemprop="url">Kubernete Ingress and Services troubleshooting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-10 00:52:24 / Modified: 01:11:01" itemprop="dateCreated datePublished" datetime="2023-09-10T00:52:24+08:00">2023-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernete/" itemprop="url" rel="index"><span itemprop="name">Kubernete</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Ingress-and-Services-troubleshooting"><a href="#Kubernetes-Ingress-and-Services-troubleshooting" class="headerlink" title="Kubernetes Ingress and Services troubleshooting"></a>Kubernetes Ingress and Services troubleshooting</h1><ul>
<li><p>Traffic flow: Internet → Ingress controller rule (according to your Ingress YAML) → Service → Pods</p>
</li>
<li><p>Debug flow: Pods → Service → Ingress → Ingress controller → Internet</p>
</li>
</ul>
<h2 id="Check-the-Deployment-amp-Pods"><a href="#Check-the-Deployment-amp-Pods" class="headerlink" title="Check the Deployment &amp; Pods"></a>Check the Deployment &amp; Pods</h2><ol>
<li>Makes sure that the Pod is up and running (Pod’s “Status” is “Running”). If not, checks the Deployment/Pod Resource Events and log to fix the problem.</li>
<li>If you are using HTTP GET livenessProbe, ensure your Service and Ingress are deployed beforehand.</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># logs of deployment</span></span><br><span class="line">$ kubectl logs deployment/&lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># follow logs of deployment, ctrl+c to quit</span></span><br><span class="line">$ kubectl logs -f deployment/&lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># check &quot;Events&quot; at bottom of the output</span></span><br><span class="line">$ kubectl describe deployment &lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -n &lt;namespace&gt;</span><br><span class="line">$ kubectl logs pod/&lt;name-of-pod&gt; -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe pod &lt;name-of-pod&gt; -o wide -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Check-the-port-mapping"><a href="#Check-the-port-mapping" class="headerlink" title="Check the port mapping"></a>Check the port mapping</h2><img src="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/1.png" width="80%" height="80%" alt="1">

<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a><br>    - An Ingress may be configured to give Services externally-reachable URLs, load balance traffic, terminate SSL / TLS, and offer name-based virtual hosting. An Ingress controller is responsible for fulfilling the Ingress, usually with a load balancer, though it may also configure your edge router or additional frontends to help handle the traffic.<br>    - An Ingress does not expose arbitrary ports or protocols. Exposing services other than HTTP and HTTPS to the internet typically uses a service of type Service.Type=NodePort or Service.Type=LoadBalancer.</p>
</blockquote>
<h2 id="Check-the-Service"><a href="#Check-the-Service" class="headerlink" title="Check the Service"></a>Check the Service</h2><ol>
<li>Checks the “Endpoints” field in Service, which should match the “IP” of Pods.</li>
<li>If you are using public cloud like GKE, AKS…, you can modify the Service Types to LoadBalancer to expose your Service publicly without ingress. If this work for you, meaning that your Pods and Service work correctly, problems are cause by others.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get service -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe service &lt;name-of-pod&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Check-the-Ingress-amp-Ingress-Controller-Logs-and-Resource-Events"><a href="#Check-the-Ingress-amp-Ingress-Controller-Logs-and-Resource-Events" class="headerlink" title="Check the Ingress &amp; Ingress Controller Logs and Resource Events"></a>Check the Ingress &amp; Ingress Controller Logs and Resource Events</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a><br>    - In order for the Ingress resource to work, the cluster must have an ingress controller running.<br>    - Unlike other types of controllers which run as part of the kube-controller-manager binary, Ingress controllers are not started automatically with a cluster in public cloud like GKE, AKS…. You need to choose the ingress controller implementation that best fits your cluster.<br>    - Ingress Controller in AKS is AKS Application Gateway Ingress Controller ,which is ingress-appgw-deployment below. The ingress controller runs as a pod within the AKS cluster. It consumes Kubernetes Ingress Resources and converts them to an Azure Application Gateway configuration which allows the gateway to load-balance traffic to Kubernetes pods.</p>
</blockquote>
<ol>
<li><p>Checks your Ingress for any Event or error log</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe ingress &lt;name-of-ingress&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>Checks your ingress controller configuration to see if it’s rule match the ingress you just apply.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">λ kubectl get deployment  -n kube-system</span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">ingress-appgw-deployment   1/1     1            1           48d</span><br><span class="line">...</span><br><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">azure-cni-networkmonitor-2fmfk              1/1     Running   0          7d5h</span><br><span class="line">...</span><br><span class="line">azure-ip-masq-agent-6k4rm                   1/1     Running   0          3d5h</span><br><span class="line">...</span><br><span class="line">coredns-84d976c568-pjt8q                    1/1     Running   1          86d</span><br><span class="line">...</span><br><span class="line">ingress-appgw-deployment-7b8b687b46-scvs7   1/1     Running   315        3d5h</span><br><span class="line">kube-proxy-4c6qw                            1/1     Running   0          7d5h</span><br><span class="line">...</span><br><span class="line">metrics-server-569f6547dd-j2wjz             1/1     Running   5          86d</span><br><span class="line">...</span><br><span class="line">$ kubectl describe pod ingress-appgw-deployment-7b8b687b46-scvs7 -n kube-system</span><br></pre></td></tr></table></figure>

<p> Finally figure out that the problem is caused by Ingress controller fail to convert Ingress YAML to Azure Application Gateway configuration while you update your Ingress YAML or Pod Service endpoint, including livenessProbe.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f -n kube-system ingress-appgw-deployment-7b8b687b46-scvs7 | grep --color=always -i error</span><br><span class="line">E0110 03:19:02.123462       1 requestroutingrules.go:386] A path-rule with path <span class="string">&#x27;/merchant/*&#x27;</span> already exists <span class="keyword">in</span> config <span class="keyword">for</span> BackendPool <span class="string">&#x27;/subscriptions/49fc9d19-f517-4ca5-a93e-76ed0fbd0ab1/resourceGroups/xxx/providers/Microsoft.Network/applicationGateways/aks-gw/backendAddressPools/defaultaddresspool&#x27;</span>. Duplicate path-rule with BackendPool <span class="string">&#x27;/subscriptions/49fc9d19-f517-4ca5-a93e-76ed0fbd0ab1/resourceGroups/xxx/providers/Microsoft.Network/applicationGateways/aks-gw/backendAddressPools/pool-payment-payment-svc-80-bp-80&#x27;</span> will not be applied</span><br></pre></td></tr></table></figure>
</li>
<li><p>Restart Ingress Controller</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout restart deployment &lt;your-ingress-controller-deployment&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>For AKS Application Gateway, check:<br>    - <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-probe-overview">Application Gateway health monitoring overview</a><br>    - <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-create-probe-portal">Create a custom probe for Application Gateway by using the portal</a></p>
</blockquote>
<h2 id="Reason-for-Application-Gateway-failure"><a href="#Reason-for-Application-Gateway-failure" class="headerlink" title="Reason for Application Gateway failure"></a>Reason for Application Gateway failure</h2><p>The reasons that may cause Application Gateway fail to monitor and apply Ingress configuration.</p>
<ol>
<li><p>Using HTTPS without a Secret that contains a TLS private key and certificate. If you are using let’s encrypt to automatically produce secret file with tls.crt and tls.key with kubernates.io/tls type, make sure it hasn’t block by your your AKS firewall, which will result in wrong type of Secret(Opaque).</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">cert</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">key</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>redirecting problem</p>
<p> <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42101808/ingress-gives-502-error">Ingress gives 502 error</a></p>
<p> noticing that the application must return a 200 status code at ‘/’. if your application was returning a 302 (redirect to login), which would cause the health fail. When the health check fails, the ingress resource returns 502.</p>
</li>
<li><p>Backend path rule conflict.</p>
<p> If you specify the backend-path-prefix in Ingress, make sure it did not conflict your backend resource Deployment livenessProbe path prefix.</p>
<p> Deployment</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/payment_resource/healthcheck.jsp</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">180</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p> Ingress</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-payment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">payment</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/backend-path-prefix:</span> <span class="string">/payment_resource/</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/connection-draining:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/connection-draining-timeout:</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/cookie-based-affinity:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">letsencrypt-production</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.allow-http:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">azure/application-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">xxx.xxx.xxx.azure.com</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">aks-ingress-cert</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">xxx.xxx.xxx.azure.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/payment/*</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">payment-svc</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p> Visit <a target="_blank" rel="noopener" href="https://xxx.xxx.xxx.azure.com/payment/healthcheck.jsp">https://xxx.xxx.xxx.azure.com/payment/healthcheck.jsp</a> , which would redirect to backend resource endpoint <a target="_blank" rel="noopener" href="https://xxx.xxx.xxx.azure.com/payment_resource/healthcheck.jsp">https://xxx.xxx.xxx.azure.com/payment_resource/healthcheck.jsp</a> .</p>
</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://azure.github.io/application-gateway-kubernetes-ingress/annotations/">Backend Path Prefix</a><br>This annotation allows the backend path specified in an ingress resource to be re-written with prefix specified in this annotation. This allows users to expose services whose endpoints are different than endpoint names used to expose a service in an ingress resource.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://stacksimplify.com/azure-aks/azure-kubernetes-service-ingress-context-path-routing/">Ingress — Context Path Based Routing</a></p>
<img src="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/2.png" width="80%" height="80%" alt="2">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/10/Docker-volumes-Problem-onUbuntu-on-WSL2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/10/Docker-volumes-Problem-onUbuntu-on-WSL2/" class="post-title-link" itemprop="url">Docker volumes Problem onUbuntu on WSL2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-10 00:29:48 / Modified: 00:51:05" itemprop="dateCreated datePublished" datetime="2023-09-10T00:29:48+08:00">2023-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Docker-volumes-Problem-onUbuntu-on-WSL2"><a href="#Docker-volumes-Problem-onUbuntu-on-WSL2" class="headerlink" title="Docker volumes Problem onUbuntu on WSL2"></a>Docker volumes Problem onUbuntu on WSL2</h1><h2 id="Docker-Volume-type"><a href="#Docker-Volume-type" class="headerlink" title="Docker Volume type"></a>Docker Volume type</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker</a></p>
<ul>
<li><p>bind mounts :</p>
<p>When you use a bind mount, a file or directory on the host machine is mounted into a container. They rely on the host machine’s filesystem having a specific directory structure available.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  — &#x2F;mnt&#x2F;c&#x2F;work&#x2F;db:&#x2F;var&#x2F;lib&#x2F;mysql”</span><br><span class="line">--&gt; manipulate data in &#x2F;mnt&#x2F;c&#x2F;work&#x2F;db on Ubuntu on WSL &#x3D;&#x3D; manipulate data &#x2F;var&#x2F;lib&#x2F;mysql in docker volume</span><br></pre></td></tr></table></figure></li>
<li><p>volumes :<br><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">volumes</a></p>
</li>
</ul>
<p>  Volumes are stored in a part of the host filesystem which is managed by Docker (<code>/var/lib/docker/volumes/</code> on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.</p>
<p>  When you create a volume, it is stored within a directory on the Docker host. When you mount the volume into a container, this directory is what is mounted into the container. This is similar to the way that bind mounts work, except that volumes are managed by Docker and are isolated from the core functionality of the host machine.</p>
<h2 id="File-permission-problem"><a href="#File-permission-problem" class="headerlink" title="File permission problem :"></a>File permission problem :</h2><img src="/2023/09/10/Docker-volumes-Problem-onUbuntu-on-WSL2/1.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">


<p>When you use bind mounts for persisting data in generated by and used by Docker containers on Ubuntu on WSL2, you may encounter file permission problems.</p>
<ul>
<li><p>docker-compose.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attr">db_mysql:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./db_context</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-db-mysql</span></span><br><span class="line">    <span class="attr">env_file:</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;DB_DATA_PATH_MYSQL&#125;:/var/lib/mysql&quot;</span></span><br><span class="line">    <span class="attr">command:</span>  <span class="string">--transaction-isolation=READ-COMMITTED</span> <span class="string">--socket=/tmp/mysql.sock</span> <span class="string">--sql_mode=&quot;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3316</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">docker_network:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.16</span><span class="number">.238</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">db_mysql</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Dockerfile-db_mysql</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">mysql:8.0</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">my.cnf</span> <span class="string">/etc/mysql/conf.d/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>.evn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DB_DATA_PATH_MYSQL&#x3D;&#x2F;mnt&#x2F;c&#x2F;work&#x2F;db</span><br><span class="line">MYSQL_ROOT_PASSWORD&#x3D;123456</span><br><span class="line">MYSQL_USER&#x3D;test</span><br><span class="line">MYSQL_PASSWORD&#x3D;test123</span><br></pre></td></tr></table></figure>
</li>
<li><p>Error log like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqld: Can&#39;t change permissions of the file &#39;ca-key.pem&#39; (Errcode: 1 - Operation not permitted)</span><br><span class="line">2022-03-25T05:32:05.406540Z 0 [ERROR] Could not set file permission for ca-key.pem</span><br><span class="line">2022-03-25T05:32:05.406553Z 0 [ERROR] Aborting</span><br><span class="line">2022-03-04T02:58:39.130160Z 0 [ERROR] [MY-010295] [Server] Could not set file permission for ca.pem</span><br><span class="line">2022-03-04T02:58:39.130213Z 0 [ERROR] [MY-013236] [Server] The designated data directory &#x2F;var&#x2F;lib&#x2F;mysql&#x2F; is unusable. You can remove all files that the server added to it.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>These problems are caused by sharing files permission across the Windows Subsystem for Linux (WSL) and Window. Windows file systems differ substantially from Linux file systems. WSL use a filesystem plugin DrvFs to support interop between WSL and the Windows filesystem.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/wsl/blob/main/WSL/wsl-config.md">MicrosoftDocs/WSLPublic</a><br>  <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/commandline/chmod-chown-wsl-improvements/">Chmod/Chown WSL Improvements</a><br>  <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/archive/blogs/wsl/wsl-file-system-support">WSL File System Support</a><br>  <strong>DrvFs</strong><br>    To facilitate interoperability with Windows, WSL uses the DrvFs file system. WSL automatically mounts all fixed drives with supported file systems under /mnt, such as /mnt/c, /mnt/d, etc. Currently, only NTFS and ReFS volumes are supported.<br>    (window) C:\work\db ← → (WSL) /mnt/c/work/db</p>
</blockquote>
<h3 id="Solution-1-volume"><a href="#Solution-1-volume" class="headerlink" title="Solution 1 : volume"></a>Solution 1 : volume</h3><img src="/2023/09/10/Docker-volumes-Problem-onUbuntu-on-WSL2/2.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">


<p>Use volumes which are completely managed by Docker to solve this problem.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attr">db_mysql:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./db_context</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-db-mysql</span></span><br><span class="line">    <span class="attr">env_file:</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;DB_DATA_PATH_MYSQL&#125;:/var/lib/mysql&quot;</span></span><br><span class="line">    <span class="attr">command:</span>  <span class="string">--transaction-isolation=READ-COMMITTED</span> <span class="string">--socket=/tmp/mysql.sock</span> <span class="string">--sql_mode=&quot;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3316</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">docker_network:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.16</span><span class="number">.238</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">db_mysql</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"> <span class="attr">mysql:</span></span><br></pre></td></tr></table></figure>

<p>WSL2 Ubuntu</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up build</span><br><span class="line">$ docker <span class="built_in">exec</span> -it db_mysql bash</span><br><span class="line">root@fdg453:/<span class="comment"># mysql -h 127.0.0.1 -u test -p</span></span><br><span class="line">Enter password : test123</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>Also, you may encounter other problems likes :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld: [Warning] World-writable config file &#39;&#x2F;etc&#x2F;mysql&#x2F;conf.d&#x2F;my.cnf&#39; is ignored.</span><br></pre></td></tr></table></figure>

<p>After mount file systems into WSL2 from Window, my.cnf file permissions were changed to 777 from 744. Docker daemon copies files from the host to the container verbatim, inluding numeric user ids, resulting inmy.cnfwith file permissions 777 in docker container. Mysql’s security mechanism ignores the file because of insecure read and write permissions. We need to change permissions of <code>my.cnf</code>.</p>
<p>Consider below methods to fix:</p>
<ol>
<li>Chmod in DockerFile : <a target="_blank" rel="noopener" href="https://denibertovic.com/posts/handling-permissions-with-docker-volumes/">Fixing World-writable MySql error in Docker, HANDLING PERMISSIONS WITH DOCKER VOLUMES</a></li>
<li>Modified file permissions on host before Docker daemon copy it into container.</li>
</ol>
<p>Modified file permissions for target file on WSL2 ubuntu</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/mnt/c/work/db_context<span class="comment"># ls -al</span></span><br><span class="line">total 0</span><br><span class="line">drwxrwxrwx 1 xxx xxx 512 Mar 25 16:20 .</span><br><span class="line">drwxrwxrwx 1 xxx xxx 512 Mar 28 12:12 ..</span><br><span class="line">-rwxrwxrwx 1 xxx xxx  49 Mar 25 16:20 Dockerfile-db-mysql</span><br><span class="line">-rw-r--r-- 1 xxx xxx 389 Mar 17 11:28 my.cnf</span><br><span class="line">/mnt/c/work/db_context<span class="comment"># chmod 644 my.cnf</span></span><br><span class="line">/mnt/c/work/db_context<span class="comment"># ls -al</span></span><br><span class="line">total 0</span><br><span class="line">drwxrwxrwx 1 xxx xxx 512 Mar 25 16:20 .</span><br><span class="line">drwxrwxrwx 1 xxx xxx 512 Mar 28 12:12 ..</span><br><span class="line">-rwxrwxrwx 1 xxx xxx  49 Mar 25 16:20 Dockerfile-db-mysql</span><br><span class="line">-rw-r--r-- 1 xxx xxx 389 Mar 17 11:28 my.cnf</span><br></pre></td></tr></table></figure>


<h3 id="Solution-2-bind-mount-wsl-conf"><a href="#Solution-2-bind-mount-wsl-conf" class="headerlink" title="Solution 2 : bind mount + wsl.conf"></a>Solution 2 : bind mount + wsl.conf</h3><img src="/2023/09/10/Docker-volumes-Problem-onUbuntu-on-WSL2/3.png" width="80%" height="80%" alt="inconsistency_between_database_and_cache">

<p>Add wsl.conf with metadataautomount options to support Linux system permissions in WSL2.(MicrosoftDocs/WSLPublic)</p>
<p>WSL2 ubuntu</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># login root</span></span><br><span class="line">$ sudo -i</span><br><span class="line">$ <span class="built_in">cd</span> /etc/</span><br><span class="line"><span class="comment"># create wsl.conf</span></span><br><span class="line">$ vim wsl.conf</span><br></pre></td></tr></table></figure>

<p>wsl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[automount]</span><br><span class="line">options &#x3D; &quot;metadata&quot;</span><br></pre></td></tr></table></figure>

<p>restart WSL2 (Using PowerShell)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wsl --shutdown</span><br><span class="line">$ wsl</span><br><span class="line"><span class="comment"># start docker</span></span><br><span class="line">$ service docker start</span><br><span class="line"><span class="comment"># restart your mysql project</span></span><br><span class="line">$ docker-compose up</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/07/How-to-deploy-a-Kubernate-Job-by-client-go-in-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/07/How-to-deploy-a-Kubernate-Job-by-client-go-in-cluster/" class="post-title-link" itemprop="url">How to deploy a Kubernate Job by client-go in cluster</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-09-07 23:47:47" itemprop="dateCreated datePublished" datetime="2023-09-07T23:47:47+08:00">2023-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-10 00:53:16" itemprop="dateModified" datetime="2023-09-10T00:53:16+08:00">2023-09-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernete/" itemprop="url" rel="index"><span itemprop="name">Kubernete</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernets-API-Server"><a href="#Kubernets-API-Server" class="headerlink" title="Kubernets API Server"></a><strong>Kubernets API Server</strong></h1><p>The API server is a component of the Kubernetes control plane that exposes the Kubernetes API via HTTPS. It is the main management point of the entire cluster. To invoke this API, the client requests needs implement the correct auth(authentication and authorization). API server is also responsible for the authentication and authorization mechanism, processes REST operations, validates them, and updates the corresponding objects in Etcd. There are two main authentication mechanisms we can use handle the API Server auth, TLS/SSL Certificate-based auth(X509) and Token-based auth.</p>
<h1 id="Role-Based-Access-Control"><a href="#Role-Based-Access-Control" class="headerlink" title="Role-Based Access Control"></a><strong>Role-Based Access Control</strong></h1><p>In the Kubernetes cluster , the mechanism responsible for completing the authorization work is RBAC (Role-Based Access Control). RBAC defines policies for restricting and controlling user access to resources of a system by using roles attached to users. However, RBAC policies can also govern the behavior of software resources. A <em>service account</em> provides an identity for processes that run in a Pod, and maps to a ServiceAccount object. A secret with access token is generated when ServiceAccount object is deployed. After specify <code>serviceAccountName</code> with in a pod, the secret will mount into pod at <code>/var/run/secrets/kubernetes.io/serviceaccount</code> . The pod can access API Server with permissions defined in <code>serviceAccountName</code> .</p>
<p>RBAC authorizations can define permissions/policies that can be limited within a namespace(Role) or the entire cluster(ClusterRule).</p>
<img src="/2023/09/07/How-to-deploy-a-Kubernate-Job-by-client-go-in-cluster/1.png" width="100%" height="100%" alt="1">

<h1 id="ServiceAccountToken"><a href="#ServiceAccountToken" class="headerlink" title="ServiceAccountToken"></a><strong>ServiceAccountToken</strong></h1><p>Kubelet automatically mount a default ServiceAccount’s API credentials (ServiceAccountToken) in the same namespace as the pod is create without specifying a ServiceAccount. This allow pod to access API server incluster by ServiceAccountToken. You can opt out of automounting API credentials on <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> for a service account by setting <code>automountServiceAccountToken: false</code> on the ServiceAccount.</p>
<p>serviceAccount, Role, RoleBinding</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: service-account-jobs</span><br><span class="line">  namespace: default</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: job-operation</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;, &quot;batch&quot;]</span><br><span class="line">    resources: [&quot;jobs&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: job-operation</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: service-account-jobs</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: job-operation</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<p>deployment.yaml (program running in pod which want to access Kubernate API Server within cluster to deploy a Job)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: program</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: program</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: program</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: service-account-jobs</span><br><span class="line">      containers:</span><br><span class="line">      - name: program</span><br><span class="line">        image: &#123;&#123; .Values.program.image &#125;&#125;</span><br><span class="line">        command:</span><br><span class="line">          - &quot;bin&#x2F;sh&quot;</span><br><span class="line">          - &quot;-c&quot;</span><br><span class="line">          - &quot;&#x2F;go&#x2F;bin&#x2F;server -sql&#x3D;&#x2F;etc&#x2F;sql&#x2F;postgres.txt -worker-job&#x3D;&#x2F;etc&#x2F;jobs&#x2F;worker-job.yaml&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: postgre-sql</span><br><span class="line">            mountPath: &#x2F;etc&#x2F;sql</span><br><span class="line">          - name: worker-job</span><br><span class="line">            mountPath: &#x2F;etc&#x2F;jobs</span><br><span class="line">      volumes:</span><br><span class="line">        - name: postgre-sql</span><br><span class="line">          configMap:</span><br><span class="line">            name: configs</span><br><span class="line">            items:</span><br><span class="line">              - key: postgres.txt</span><br><span class="line">                path: postgres.txt</span><br><span class="line">        - name: worker-job</span><br><span class="line">          configMap:</span><br><span class="line">            name: configs</span><br><span class="line">            items:</span><br><span class="line">              - key: worker-job.yaml</span><br><span class="line">                path: worker-job.yaml</span><br></pre></td></tr></table></figure>

<p>configmap.yaml (render by helm, place to store Job template)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: configs</span><br><span class="line">data:</span><br><span class="line">  &#123;&#123;- .Files.Get .Values.configmapStrings | nindent 2 &#125;&#125;</span><br><span class="line">  &#123;&#123;- (.Files.Glob .Values.configmapFiles).AsConfig | nindent 2 &#125;&#125;</span><br><span class="line">  &#123;&#123;- (.Files.Glob .Values.configmapJobsFiles).AsConfig | nindent 2 &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>local-values.yaml (render by helm)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configmapFiles: &quot;configmaps&#x2F;files&#x2F;local&#x2F;**&quot;</span><br><span class="line">configmapStrings: &quot;configmaps&#x2F;strings&#x2F;local.yaml&quot;</span><br><span class="line">configmapJobsFiles: &quot;configmaps&#x2F;jobs&#x2F;local&#x2F;**&quot;</span><br></pre></td></tr></table></figure>

<p>Job template</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch&#x2F;v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: worker</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: worker</span><br><span class="line">spec:</span><br><span class="line">  ttlSecondsAfterFinished: 100</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: worker</span><br><span class="line">        image: worker:target</span><br><span class="line">        imagePullPolicy: Never</span><br><span class="line">        command:</span><br><span class="line">          - &quot;bin&#x2F;sh&quot;</span><br><span class="line">          - &quot;-c&quot;</span><br><span class="line">          - &quot;&#x2F;go&#x2F;bin&#x2F;image_worker -sql&#x3D;&#x2F;etc&#x2F;sql&#x2F;postgres.txt -custom&#x3D;$&#123;CUSTOM_ID&#125;&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: postgre-sql</span><br><span class="line">            mountPath: &#x2F;etc&#x2F;sql</span><br><span class="line">      restartPolicy: Never</span><br><span class="line">      volumes:</span><br><span class="line">        - name: postgre-sql</span><br><span class="line">          configMap:</span><br><span class="line">            name: configs</span><br><span class="line">            items:</span><br><span class="line">              - key: postgres.txt</span><br><span class="line">                path: postgres.txt</span><br><span class="line">  backoffLimit: 0</span><br></pre></td></tr></table></figure>

<p>Golang program read in Job template YAML as an parameter by golang flag and parse YAML to client-go Job spec. You can then customize Job setting. Beware that the InClusterConfig only work when running program within cluster.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">package k8sutil</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line"> &quot;context&quot;</span><br><span class="line"> &quot;fmt&quot;</span><br><span class="line"> &quot;os&quot;</span><br><span class="line"> &quot;strings&quot;</span><br><span class="line"></span><br><span class="line"> batchv1 &quot;k8s.io&#x2F;api&#x2F;batch&#x2F;v1&quot;</span><br><span class="line"> metav1 &quot;k8s.io&#x2F;apimachinery&#x2F;pkg&#x2F;apis&#x2F;meta&#x2F;v1&quot;</span><br><span class="line"> &quot;k8s.io&#x2F;client-go&#x2F;kubernetes&quot;</span><br><span class="line"> &quot;k8s.io&#x2F;client-go&#x2F;kubernetes&#x2F;scheme&quot;</span><br><span class="line"> &quot;k8s.io&#x2F;client-go&#x2F;rest&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func connectToK8s() (*kubernetes.Clientset, error) &#123;</span><br><span class="line"> &#x2F;&#x2F; creates the in-cluster config</span><br><span class="line"> config, err :&#x3D; rest.InClusterConfig()</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return nil, fmt.Errorf(&quot;failed to create in-cluster cofig: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; creates the clientset</span><br><span class="line"> clientset, err :&#x3D; kubernetes.NewForConfig(config)</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return nil, fmt.Errorf(&quot;failed to create k8s client set: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> return clientset, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func resolveJobTemplate(imageWorkerJobYamlPath string) (*batchv1.Job, error) &#123;</span><br><span class="line"> &#x2F;&#x2F; read in k8s yaml file</span><br><span class="line"> b, err :&#x3D; os.ReadFile(imageWorkerJobYamlPath)</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return nil, fmt.Errorf(&quot;failed to read job yaml file: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; deserialize k8s yaml to k8s object</span><br><span class="line"> decode :&#x3D; scheme.Codecs.UniversalDeserializer().Decode</span><br><span class="line"> obj, groupVersionKind, err :&#x3D; decode([]byte(b), nil, nil)</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return nil, fmt.Errorf(&quot;failed to decode yaml file to object: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> var job *batchv1.Job</span><br><span class="line"> if groupVersionKind.Kind &#x3D;&#x3D; &quot;Job&quot; &#123;</span><br><span class="line">  job &#x3D; obj.(*batchv1.Job)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> return job, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; LaunchImageWorkerK8sJob luach a worker job with specific job name and customID</span><br><span class="line">func LaunchImageWorkerK8sJob(ctx context.Context, jobName string, customID string, imageWorkerJobYamlPath string) error &#123;</span><br><span class="line"> &#x2F;&#x2F; resolve kubernate job template</span><br><span class="line"> jobSpec, err :&#x3D; resolveJobTemplate(imageWorkerJobYamlPath)</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return fmt.Errorf(&quot;failed to resolve kubernate job template: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; connect to k8s</span><br><span class="line"> clientset, err :&#x3D; connectToK8s()</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return fmt.Errorf(&quot;failed to connect to kubernate: %v&quot;, err)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; customize Job setting</span><br><span class="line"> &#x2F;&#x2F; job name setting</span><br><span class="line"> jobSpec.ObjectMeta.Name &#x3D; jobName</span><br><span class="line"> &#x2F;&#x2F; replace customiD flag with target customID</span><br><span class="line"> commandWithFlag :&#x3D; jobSpec.Spec.Template.Spec.Containers[0].Command[2]</span><br><span class="line"> replaceCustomIDFlag :&#x3D; strings.Replace(commandWithFlag, &quot;$&#123;CUSTOM_ID&#125;&quot;, customID, 1)</span><br><span class="line"> jobSpec.Spec.Template.Spec.Containers[0].Command[2] &#x3D; replaceCustomIDFlag</span><br><span class="line"></span><br><span class="line"> namespace :&#x3D; jobSpec.Namespace</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; apply k8s job</span><br><span class="line"> jobs :&#x3D; clientset.BatchV1().Jobs(namespace)</span><br><span class="line"> jobDetail, err :&#x3D; jobs.Create(ctx, jobSpec, metav1.CreateOptions&#123;&#125;)</span><br><span class="line"> if err !&#x3D; nil &#123;</span><br><span class="line">  return fmt.Errorf(&quot;failed to create kubernete job: %v \n Job detail: %v&quot;, err, jobDetail)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Reference</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/50510381/creating-a-job-with-kubernetes-client-go">Creating a Job with Kubernetes client-go</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration/main.go">client-go/examples/in-cluster-client-configuration/main.go</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/60885448/how-to-run-kubectl-within-a-job-in-a-namespace">How to run kubectl within a job in a namespace?</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/client-go/issues/193">Support for parsing K8s yaml spec into client-go data structures #193</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/">Authenticating</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34388593/how-to-enter-an-optional-flag-with-no-parameters-in-go-cli-program">How to enter an optional flag with no parameters in Go CLI program</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Using RBAC Authorization</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Configure Service Accounts for Pods</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/rahasak/kubernetes-http-api-with-authentication-and-authorization-c0cb7051114f">Kubernetes HTTP API with Authentication and Authorization</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/">Kubelet authentication/authorization</a></li>
<li><a target="_blank" rel="noopener" href="https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/">How To Call Kubernetes API using Simple HTTP Client</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/07/Database-Cache-Consistency-Strategies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/07/Database-Cache-Consistency-Strategies/" class="post-title-link" itemprop="url">Database Cache Consistency Strategies</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-07 23:28:11 / Modified: 23:47:11" itemprop="dateCreated datePublished" datetime="2023-09-07T23:28:11+08:00">2023-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/System-Design/" itemprop="url" rel="index"><span itemprop="name">System Design</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Database-Cache-Consistency-Strategies"><a href="#Database-Cache-Consistency-Strategies" class="headerlink" title="Database Cache Consistency* Strategies**"></a>Database Cache Consistency* Strategies**</h1><ul>
<li>Cache Aside</li>
<li>Read/Write Through</li>
<li>Write Behind Caching</li>
</ul>
<h1 id="Cache-Aside-Pattern"><a href="#Cache-Aside-Pattern" class="headerlink" title="Cache Aside Pattern"></a>Cache Aside Pattern</h1><p><em>Eventually Database Cache Consistency</em></p>
<ul>
<li>Cache miss: The application retrieves data from the cache. If data doesn’t exists in the cache, retrieves data from database and stores it in the cache. The requested data is returned from database.</li>
<li>Cache hit: The application retrieves data from the cache and returns.</li>
<li>Update data: Stores the data in the database first, and then invalidates the cache after success.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://catsincode.com/caching-strategy/">Cache-aside caching strategy</a><br><img src="/2023/09/07/Database-Cache-Consistency-Strategies/1.png" width="40%" height="40%" alt="1"></p>
<p>Cache-aside strategy fits well for data that is read often and not so often stored or updated. One downside of this strategy is possible data inconsistency between the cache and the database.</p>
<p>Consider the following situation.</p>
<img src="/2023/09/07/Database-Cache-Consistency-Strategies/inconsistency_between_database_and_cache.png" alt="inconsistency_between_database_and_cache">

<p>inconsistency between the cache and the database</p>
<p>However, the probability of occurrence may be very low in practice, because the write operation of the database is slower than the read operation. To avoid inconsistency of data, you can set a timeout on data in cache and it will automatically be deleted in a time period.</p>
<h1 id="Read-Write-Through-Pattern"><a href="#Read-Write-Through-Pattern" class="headerlink" title="Read/Write Through Pattern"></a><strong>Read/Write Through Pattern</strong></h1><p><em>Strong Database Cache Consistency</em></p>
<p>Application views the backend as a single storage, and the storage maintains its own Cache.</p>
<p><strong>Read Through</strong></p>
<p>The application doesn’t orchestrate where to read the data from (cache or database). Instead, it always reads data through the cache. When the cache is invalid (expired or LRU swapped out) during query operation(request), the cache service itself loads data from database.</p>
<p><strong>Write Through</strong></p>
<p>The Write Through is similar to Read Through, but happens when data is updated. When there is data updated,</p>
<ul>
<li>if the cache is not hit, update the database directly, and then return.</li>
<li>If the cache is hit, the cache is updated, and updates the data in database. Both operations happen in a single transaction(this is a synchronous operation)</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_(computing)">A write-through cache with no-write allocation</a><br><img src="/2023/09/07/Database-Cache-Consistency-Strategies/2.png" width="40%" height="40%" alt="2"></p>
<p>It does create some extra latency on writes but at least it improves the data inconsistency problem greatly as the data in the cache and data storage is the same. Another advantage is, because application only talks to the cache, the code is much cleaner and simpler.</p>
<h1 id="Write-Behind-Caching-Pattern"><a href="#Write-Behind-Caching-Pattern" class="headerlink" title="Write Behind Caching Pattern"></a><strong>Write Behind Caching Pattern</strong></h1><p><em>Eventually Database Cache Consistency</em></p>
<p>Write-behind(also call Write Back) caching Pattern is similar to the write-through cache in a way that application only communicates with the cache. The difference is that the data gets written to the cache first. And then, written to the underlying database asynchronously. The advantage of this design is that the I/O operation of the data is extremely fast. Also, due to asynchronous update in database, the writes can be collected and then does a batch write to the database.</p>
<p>However, the problem with this is that the data is not strongly consistent and may be lost. To tackle the data inconsistency problem a system could combine the write-behind strategy with the read-through strategy. In this way up to date data is always to be read from the cache. In addition, the implementation logic of Write Back is more complicated, because it needs to track which data has been updated and needs to be stored in database.</p>
<p>When we compare it to the write-through strategy, it fits more for systems with large write and read volume that tolerate some data inconsistency. Another useful case is that when execution order of data updated doesn’t matter, like the number of page views, every time the user clicks, this field in the database is incremented by one. Execution order of SQL/request would not cause thread safety problem in concurrently write and read, since each SQL/request does the same(page views field incremented by one).</p>
<h1 id="Final"><a href="#Final" class="headerlink" title="Final"></a><strong>Final</strong></h1><p>We do not consider the transaction of the cache and under layer storage. For example, the cache is updated successfully, but the update of the database fails. Or the other way reverse. If you need strong consistency, you need to consider Transaction Processing in a Distributed System, like “two-phase commit protocol” — — prepare, commit/rollback.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><p><a target="_blank" rel="noopener" href="https://danielw.cn/cache-consistency-with-database#concepts">Cache Consistency with Database</a></p>
<p><a target="_blank" rel="noopener" href="https://catsincode.com/caching-strategy/">Caching Strategies Overview</a></p>
<p><a target="_blank" rel="noopener" href="https://catsincode.com/caching-strategy/">缓存更新的套路</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_(computing)">Cache (computing)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cache-aside">Cache-Aside pattern</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/07/Index-Locking-In-MySQL8-with-InnoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/07/Index-Locking-In-MySQL8-with-InnoDB/" class="post-title-link" itemprop="url">Index Locking In MySQL8 with InnoDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-07 23:26:30 / Modified: 23:39:05" itemprop="dateCreated datePublished" datetime="2023-09-07T23:26:30+08:00">2023-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-data-structures-for-Index"><a href="#MySQL-data-structures-for-Index" class="headerlink" title="MySQL data structures for Index"></a><strong>MySQL data structures for Index</strong></h1><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/index-btree-hash.html">8.3.9 Comparison of B-Tree and Hash Indexes</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7306316/b-tree-vs-hash-table">B-Tree vs Hash Table</a></p>
<ul>
<li>Hash Table: You can only access elements by their primary key <code>O(1)</code>. When you select ranges (<em>everything in between <code>x</code> and <code>y</code></em>) can result in a full table scan <code>O(n)</code> . There may be a point where your index exceeds a tolerable size compared to your hash sizes and your entire index needs to be re-built.</li>
<li>Tree algorithms support ranges selecting in <em><code>log(n)</code></em> , elements accessing and inserting by their primary key in <em><code>log(n)</code></em> .</li>
</ul>
<p><strong><em>Related topic:</em></strong></p>
<ul>
<li>Page Splitting: Create a new table with<code>NOT NULL PRIMARY KEY AUTO_INCREMENT</code> to avoid vacancy in page(higher memory usage) and to ensure orderly insertion(higher performance).</li>
<li>Primary key type: The smaller the length of the primary key, result in smaller occupied space by the ordinary index(leaf nodes in Indexes other than the primary key → primary key).</li>
</ul>
<h1 id="MySQL-Clustered-and-Secondary-Indexes"><a href="#MySQL-Clustered-and-Secondary-Indexes" class="headerlink" title="MySQL Clustered and Secondary Indexes"></a><strong>MySQL Clustered and Secondary Indexes</strong></h1><blockquote>
<p>15.6.2.1 Clustered and Secondary Indexes</p>
<p><em>Each <code>InnoDB</code> table has a special index called the clustered index that stores row data. Typically, the clustered index is synonymous with the primary key.</em></p>
</blockquote>
<ul>
<li>Select by primary key → find in clustered index B+ tree → get the required data(row).</li>
<li>Select by Indexes other than the primary key → find in secondary index B+ tree→ get the primary key for data → find in clustered index B+ tree → get the required data(row).</li>
</ul>
<p><strong><em>Related topic:</em></strong></p>
<p><a target="_blank" rel="noopener" href="https://www.red-gate.com/simple-talk/databases/sql-server/learn/using-covering-indexes-to-improve-query-performance/">Using Covering Indexes to Improve Query Performance</a></p>
<ul>
<li>Covering index: The covering index contains the data to be searched through include, so that the SQL query can get the required data without reaching the basic table.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.mysqltutorial.org/mysql-index/mysql-prefix-index/">MySQL Prefix Index</a></p>
<ul>
<li>Prefix index: MySQL allows you to create an index for the leading part of the column values of the string columns using the following syntax: <code>column_name(length)</code> . Create a prefix index can save space, but may increase the number of query scans and make the Covering index useless.</li>
</ul>
<h1 id="MySQL-multiversion-concurrency-control-MVCC"><a href="#MySQL-multiversion-concurrency-control-MVCC" class="headerlink" title="MySQL multiversion concurrency control (MVCC)"></a><strong>MySQL multiversion concurrency control (MVCC)</strong></h1><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-reads.html">15.7.2.4 Locking Reads</a></p>
<ul>
<li>SELECT … FOR SHARE: Sets a shared mode lock on any rows that are read. Other sessions can read the rows, but cannot modify them until your transaction commits.</li>
<li>SELECT … FOR UPDATE: For index records the search encounters, locks the rows and any associated index entries, the same as if you issued an <code>UPDATE</code> statement for those rows.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/commit.html">13.3.1 START TRANSACTION, COMMIT, and ROLLBACK Statements</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-consistent-read.html">15.7.2.3 Consistent Nonlocking Reads</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html">15.3 InnoDB Multi-Versioning</a></p>
<ul>
<li>The snapshot of the database state applies to <code>[SELECT](https://dev.mysql.com/doc/refman/8.0/en/select.html)</code> statements within a transaction, not necessarily to <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_dml">DML</a> statements.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># suppose command below are in each transaction, REPEATABLE READ# Snapshot&#x2F;Consistent read, no lock (MVCC, redo log), each consistent read within a transaction sets and reads its own fresh snapshot.</span><br><span class="line">select * from table where id &#x3D; ?;</span><br><span class="line">-----------------------------------------------------------------# See the “freshest” state of the database, A SELECT blocks until the transaction containing the freshest rows ends.# set S lock</span><br><span class="line">select * from table where id &#x3D; ? for share;# set X lock</span><br><span class="line">select * from table where id &#x3D; ? for update;show engine innodb status;</span><br></pre></td></tr></table></figure>

<h1 id="MySQL-Lock"><a href="#MySQL-Lock" class="headerlink" title="MySQL Lock"></a><strong>MySQL Lock</strong></h1><h2 id="Lock-types-for-MySQL-server"><a href="#Lock-types-for-MySQL-server" class="headerlink" title="Lock types for MySQL server:"></a><strong>Lock types for MySQL server:</strong></h2><p><strong><em>1.Table Lock (</em></strong><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/lock-tables.html">13.3.6 LOCK TABLES and UNLOCK TABLES Statements</a>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES</span><br><span class="line">    tbl_name [[AS] alias] lock_type</span><br><span class="line">    [, tbl_name [[AS] alias] lock_type] ...lock_type: &#123;</span><br><span class="line">    READ [LOCAL]</span><br><span class="line">  | [LOW_PRIORITY] WRITE</span><br><span class="line">&#125;UNLOCK TABLES</span><br></pre></td></tr></table></figure>

<p>A session can release its table locks explicitly with <code>UNLOCK TABLES</code>. If the connection for a client session terminates, whether normally or abnormally, the server implicitly releases all table locks held by the session (transactional and nontransactional). Since InnoDB supports row-level locking, we rarely use LOCK TABLES command.</p>
<p><strong><em>2. MDL(Meta data lock) (</em></strong><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/metadata-locking.html">8.11.4 Metadata Locking</a>)</p>
<p>MDL is added automatically when accesses a table. MySQL uses metadata locking to manage concurrent access to database objects and to ensure data consistency. The server achieves this by acquiring metadata locks on tables used within a transaction and deferring release of those locks until the transaction ends. MDL read lock is added when you manipulate data in a table(DML — Data Manipulation Language). MDL read lock is added when you perform a Data Definition Language(DDL) operation or <code>LOCK TABLES</code> on a table.</p>
<ul>
<li>Meta data Read lock: Read locks are not mutually exclusive, so you can have multiple threads adding, deleting, modifying, and querying a table at the same time.</li>
<li>Meta data Write lock: Read-write locks and write locks are mutually exclusive to ensure the security of operations that change the table structure. Therefore, if two threads want to add fields to a table at the same time, one of them will not start executing until the other is finished.</li>
</ul>
<p><strong><em>Related topic:</em></strong></p>
<ul>
<li>Long transaction:</li>
</ul>
<ol>
<li>DML(<strong><em>MDL read</em></strong>) block DDL(<strong><em>MDL write</em></strong>): If session A operate a DML on table Z, the fellowing DDL operation on table Z will be blocked until transaction in session A completes. To solve this problem, check <code>innodb_trx</code> table in <code>information_schema</code> before DDL operation. Another solution is to set wait time in the DDL statement to avoid blocking fellow operation when fail in MDL acquirement. (<code>ALTER TABLE tbl_name WAIT N add column …</code>). The Performance Schema <code>[metadata_locks](https://dev.mysql.com/doc/refman/8.0/en/performance-schema-metadata-locks-table.html)</code> table exposes metadata lock information, which can be useful for seeing which sessions hold locks, are blocked waiting for locks, and so forth.</li>
<li>DDL(<strong><em>MDL write</em></strong>) block DML(<strong><em>MDL read</em></strong>)</li>
<li>DDL(<strong><em>MDL write</em></strong>) block DDL(<strong><em>MDL write</em></strong>)</li>
</ol>
<h2 id="Lock-type-for-MySQL-engine-InnoDB"><a href="#Lock-type-for-MySQL-engine-InnoDB" class="headerlink" title="Lock type for MySQL engine(InnoDB):"></a><strong>Lock type for MySQL engine(<code>InnoDB</code>):</strong></h2><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-gap-locks">15.7.1 InnoDB Locking</a></p>
<p><strong><em>Shared and Exclusive Locks</em></strong></p>
<p><code>InnoDB</code> implements standard row-level locking where there are two types of locks, shared (<code>S</code>) locks and exclusive (<code>X</code>) locks.</p>
<p><strong><em>Intention Locks</em></strong></p>
<p>Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table. There are two types of intention locks:</p>
<ul>
<li>An intention shared lock (<code>IS</code>) indicates that a transaction intends to set a <em>shared</em> lock on individual rows in a table.</li>
<li>An intention exclusive lock (<code>IX</code>) indicates that a transaction intends to set an exclusive lock on individual rows in a table.</li>
</ul>
<p>The main purpose of intention locks is to directly determine whether there is a lock conflict based on whether the intention lock exists.</p>
<ul>
<li>Before a transaction can acquire a shared lock on a row in a table, it must first acquire an <code>IS</code> lock or stronger on the table.</li>
<li>Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an <code>IX</code> lock on the table.</li>
</ul>
<p><strong><em>1.Record Locks</em></strong></p>
<p>Record locks always lock index records, even if a table is defined with no indexes. For such cases, <code>InnoDB</code> creates a hidden clustered index and uses this index for record locking.</p>
<p><strong><em>2.Gap Locks</em></strong></p>
<p>A gap lock is a lock on a gap between index records, or a lock on the gap before the first or after the last index record. For example, <code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code> prevents other transactions from inserting a value of <code>15</code> into column <code>t.c1</code>, whether or not there was already any such value in the column, because the gaps between all existing values in the range are locked.</p>
<ul>
<li>Gap locking is not needed for statements that lock rows using a unique index to search for a unique row. (This does not include the case that the search condition includes only some columns of a multiple-column unique index; in that case, gap locking does occur.).</li>
<li>Gap locks can co-exist. A gap lock taken by one transaction does not prevent another transaction from taking a gap lock on the same gap. There is no difference between shared and exclusive gap locks. They do not conflict with each other, and they perform the same function.</li>
<li>Gap locking can be disabled explicitly. This occurs if you change the transaction isolation level to <code>READ COMMITTED</code>(MySQL default transaction isolation level:<code>REPEATABLE READ</code> ) .Gap locks exist when the isolation level is <code>REPEATABLE READ</code> and <code>SERIALIZABLE.</code></li>
</ul>
<p><strong><em>3. Next-Key Locks</em></strong></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56828411/why-next-key-lock-is-called-this-way">Why Next-Key lock is called this way?</a></p>
<p>A next-key lock is a combination of a record lock on the index record and a gap lock on the <strong><em>gap</em> <em>before the index record</em></strong>.</p>
<p>By default, <code>InnoDB</code> operates in <code>REPEATABLE READ</code> transaction isolation level. In this case, <code>InnoDB</code> uses next-key locks for searches and index scans, which prevents phantom rows (see <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-next-key-locking.html">Section 15.7.4, “Phantom Rows”</a>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;t&#96; (</span><br><span class="line">  &#96;pId&#96; int(10) NOT NULL,</span><br><span class="line">  &#96;name&#96; varchar(10) DEFAULT NULL,</span><br><span class="line">  &#96;num&#96; int(10) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;pId&#96;),</span><br><span class="line">  KEY &#96;num&#96; (&#96;num&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB;covering index: num</span><br><span class="line">primary index: pId------------------------------------</span><br><span class="line">pId(int) | name(varchar) | num(int)</span><br><span class="line">---------|---------------|----------</span><br><span class="line"> 2       |      Atom     |   55</span><br><span class="line">---------|---------------|----------</span><br><span class="line"> 5       |      Bom      |   22</span><br><span class="line">---------|---------------|----------</span><br><span class="line"> 9       |     Cindy     |   33</span><br><span class="line">------------------------------------select * from table where name &#x3D; &#96;Bom&#96; for update;</span><br><span class="line"> --&gt; scan all clustered index(pid) in table</span><br><span class="line"> --&gt; addRecord Lockson clustered index 2, 5, 9</span><br><span class="line"> --&gt; addGap Lockson clustered index (-∞,2)(2,5)(5,9)(9,+∞)select * from table where pid &#x3D; 2 for update;</span><br><span class="line"> --&gt; scan pid &#x3D; 2 on clustered index(pid) in table</span><br><span class="line"> --&gt; addRecord Lockson clustered index 2select * from table where pid &#x3D; 7 for update;</span><br><span class="line"> --&gt; scan pid &#x3D; 7 on clustered index(pid) in table, not exist</span><br><span class="line"> --&gt; addGap Lockson clustered index (5, 9)select * from table where num &#x3D; 33 for share;</span><br><span class="line"> --&gt; scan secondary index(num) in table</span><br><span class="line"> --&gt; addRecord Lockson secondary index 33</span><br><span class="line"> --&gt; addGap Lockson secondary index (22,33)(33,55)select * from table where num &#x3D; 33 for update;</span><br><span class="line"> --&gt; scan secondary index(num) in table</span><br><span class="line"> --&gt; addRecord Lockson secondary index 33</span><br><span class="line"> --&gt; addGap Lockson secondary index (22,33)(33,55)</span><br><span class="line"> --&gt; scan clustered index(pid) by secondary index 33 in table</span><br><span class="line"> --&gt; addRecord Lockson clustered index 9</span><br></pre></td></tr></table></figure>

<p><strong><em>Related topic:</em></strong></p>
<ul>
<li>Long transaction.</li>
<li>Dead lock:</li>
</ul>
<ol>
<li>set <code>innodb_lock_wait_timeout</code> to avoid long blocking.</li>
<li><code>innodb_deadlock_detect = on</code> If a deadlock is found, roll back a transaction in the deadlock chain to let other transactions continue to execute.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/07/Encoding-Character-Encoding-URL-Encoding-and-Base64-Encoding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/07/Encoding-Character-Encoding-URL-Encoding-and-Base64-Encoding/" class="post-title-link" itemprop="url">Encoding: Character Encoding, URL Encoding and Base64 Encoding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-07 23:11:43 / Modified: 23:16:26" itemprop="dateCreated datePublished" datetime="2023-09-07T23:11:43+08:00">2023-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/encoding/" itemprop="url" rel="index"><span itemprop="name">encoding</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Encoding-Character-Encoding-URL-Encoding-and-Base64-Encoding"><a href="#Encoding-Character-Encoding-URL-Encoding-and-Base64-Encoding" class="headerlink" title="Encoding: Character Encoding, URL Encoding and Base64 Encoding"></a>Encoding: Character Encoding, URL Encoding and Base64 Encoding</h1><h1 id="Character-Encoding"><a href="#Character-Encoding" class="headerlink" title="Character Encoding"></a><strong>Character Encoding</strong></h1><p>Computers only can understand binary. If we want to process text, we must first convert the text to binary before computers can process it.</p>
<h2 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a><strong>ASCII</strong></h2><p>In the early days of the internet, we didn’t need to worry about any characters other than english. We use <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ASCII">American Standard Code for Information Interchange (ASCII)</a> , one byte (eight bits), to map a-z, A-Z , 0–9 and some control characters.</p>
<p>As you can imagine, there are hundreds of languages in the world. one byte is not enough for some language like Chinese or Japanese. Each country has its own standards, result in garbled characters displayed in multi-language mixed text.</p>
<h2 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a><strong>Unicode</strong></h2><p>Unicode is sometimes called the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Universal_Coded_Character_Set">Universal Coded Character Set</a> (UCS), or even ISO/IEC 10646. Unicode is made up of lots of code points (mapping lots of characters from around the world to a key that all computers can reference.) A collection of code points is called a character set, which is what Unicode is. Unicode unifies all languages into one set of codes, so that there will be no more garbled characters.</p>
<h2 id="Unicode-Transform-Protocol-UTF"><a href="#Unicode-Transform-Protocol-UTF" class="headerlink" title="Unicode Transform Protocol (UTF)"></a><strong>Unicode Transform Protocol (UTF)</strong></h2><p>UTF is a way we encode Unicode code points. The UTF encodings are defined by the Unicode standard, and are able to encode every single Unicode code point we need.</p>
<p>There are different types of UTF standards. They differ depending on the amount of bytes used to encode one code point. It also depends on whether you’re using UTF-8 (one byte per code point), UTF-16 (two bytes per code point) or UTF-32 (four bytes per code point).</p>
<p>To signal which Unicode character encoding (UTF-8, UTF-16, UTF-32) is used, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Byte_order_mark">Byte order mark (BOM)</a> is a two-byte marker at the beginning of a text that indicate what encoding is used.</p>
<h2 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a><strong>UTF-8</strong></h2><p>UTF-8 encodes all the Unicode code points from 0–127 in 1 byte (the same as ASCII). UTF encoding that converts Unicode encoding into “variable length character encoding” depend on the character you want to display. English letters are encoded into 1 byte ( 8 bits, the minimum number of bits that a UTF-8 code point will be) . Chinese and Japanese characters are are represented with 3 bytes. Some very rare characters will be encoded into 4–6 bytes. UTF-8 encoding can save space when transmitting and saving.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  character   |     ASCII     |    Unicode(UCS-16)  |      UTF-8</span><br><span class="line">--------------|---------------|---------------------|-------------------</span><br><span class="line">      A       |    01000001   |   00000000 01000001 |     01000001</span><br></pre></td></tr></table></figure>

<h2 id="HTML-charset-Attribute"><a href="#HTML-charset-Attribute" class="headerlink" title="HTML charset Attribute"></a><strong>HTML charset Attribute</strong></h2><p>To display an HTML page correctly, a web browser must know the character set used in the page. This is specified in the <code>&lt;meta&gt;</code> tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Text-Storage"><a href="#Text-Storage" class="headerlink" title="Text Storage"></a><strong>Text Storage</strong></h2><p>Unicode encoding is uniformly used in computer memory. When we need to store text on disk or transmitted over internet, text is converted to UTF-8 encoding (may be other encoding, depend on your Operating System or encoding method) for space saving. When open file , the encoding text are converted to Unicode characters in memory.</p>
<blockquote>
<p>How can I see which encoding is used in a file</p>
<p><em>You can not really automatically find out whether a file was written with encoding X originally.</em></p>
<p><em>What you can easily do though is to verify whether the complete file can be successfully decoded somehow (but not necessarily correctly) using a specific codec. If you find any bytes that are not valid for a given encoding, it must be something else.</em></p>
<p><em>The problem is that many codecs are similar and have the same “valid byte patterns”, just interpreting them as different characters.</em></p>
</blockquote>
<h1 id="URL-Encoding"><a href="#URL-Encoding" class="headerlink" title="URL Encoding"></a><strong>URL Encoding</strong></h1><p>A URL (Uniform Resource Locator) is the address of a resource in the world wide web. URLs have a well-defined structure which was formulated in <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1738">RFC 1738</a> . A URL is composed from characters including digits (0–9), letters(A-Z, a-z), and a few special characters ( “-”, “.”, “_”, “~”). If we want to transmit any character which is not a member of the above mentioned (unsafe characters like space, , &lt;, &gt;, {, } , reserved characters like ?, /, #, :), we need to encode them so that web browsers can accept and understand. URL encoding is also called percent encoding since it uses percent sign (<code>%</code>) as an escape character.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com?name&#x3D;@Test&amp;phone&#x3D;88888888</span><br><span class="line"></span><br><span class="line">          encode value part in params       |</span><br><span class="line">                                           \|?</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;www.example.com?name&#x3D;%40Test&amp;phone&#x3D;%2B919999999999</span><br></pre></td></tr></table></figure>

<h1 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a><strong>Base64</strong></h1><p>Base64 is a group of similar binary-to-text encoding schemes that represent binary data in an ASCII string format by translating it into a radix-64 representation. Base64 encoding schemes are commonly used when there is a need to encode binary data that needs to be stored and transferred over media that are designed to deal with ASCII. This is to ensure that the data remain intact without modification during transport. The resultant string of base 64 encoded data is always larger than the original. Another important distinction is that base 64 does not encrypt any information.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/everything-you-need-to-know-about-encoding/">Unicode Characters — What Every Developer Must Know About Encoding</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2021/08/05/Character-Encoding-Problems-for-Windows-and-Linux">分享幾個在 Windows 與 Linux 常見的編碼問題與解決方案</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2152738/why-do-you-need-to-encode-urls">Why do you need to encode URLs?</a></li>
<li><a target="_blank" rel="noopener" href="https://www.urlencoder.io/learn/">What is URL Encoding and How does it work?</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3538021/why-do-we-use-base64">Why do we use Base64?</a></li>
<li><a target="_blank" rel="noopener" href="https://bunny.net/academy/http/what-is-base64-encoding-and-decoding/">What is Base 64 Encoding?</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/Base64">Base64</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/10/09/Blog3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WongJY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FatCat">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/09/Blog3/" class="post-title-link" itemprop="url">從零搭建Blog part3： 圖片和其他資源</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-09 23:51:33" itemprop="dateCreated datePublished" datetime="2020-10-09T23:51:33+08:00">2020-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-09-07 23:00:56" itemprop="dateModified" datetime="2023-09-07T23:00:56+08:00">2023-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="從零搭建Blog-part3：-圖片和其他資源"><a href="#從零搭建Blog-part3：-圖片和其他資源" class="headerlink" title="從零搭建Blog part3： 圖片和其他資源"></a>從零搭建Blog part3： 圖片和其他資源</h1><h2 id="絕對路徑本地引用"><a href="#絕對路徑本地引用" class="headerlink" title="# 絕對路徑本地引用"></a># 絕對路徑本地引用</h2><p>當Hexo項目中只用到少量圖片時，可以將圖片統一放在source/images文件夾中，通過markdown語法訪問它們。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](&#x2F;images&#x2F;image.jpg)</span><br></pre></td></tr></table></figure>

<p>圖片既可以在首頁內容中訪問到，也可以在文章正文中訪問到。</p>
<ul>
<li><p><code>![example](assetsTest/example.png)</code></p>
<p>幾乎所有的 markdown 編輯器都支持的相對引用的寫法，在markdown 編輯器的預覽視圖中都能正常顯示圖片，但在主頁和文章中無法正常顯示。</p>
</li>
</ul>
<p>為了解決無法在主頁和文章中正常顯示的問題，需要安裝<a target="_blank" rel="noopener" href="https://github.com/xcodebuild/hexo-asset-image">hexo-asset-image</a>插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-asset-image@0.0.1 --save</span><br></pre></td></tr></table></figure>



<h2 id="相對路徑本地引用"><a href="#相對路徑本地引用" class="headerlink" title="# 相對路徑本地引用"></a># 相對路徑本地引用</h2><p>圖片除了可以放在統一的images文件夾中，還可以放在文章自己的目錄中。文章的目錄可以通過站點配置文件_config.yml來生成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#_config.yml</span><br><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure>

<p>config.yml文件中的配置項<code>post_asset_folder</code>設為<code>true</code>後，執行命令<code>$ hexo new post_nam</code>e，在source/_posts中會生成文章<code>post_name.md</code>和<code>同名文件夾post_name</code>。將圖片資源放在<code>post_name文件夾</code>中，文章就可以使用相對路徑引用圖片資源了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](image.jpg)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>![example](example.png)</code></p>
<p>Hexo 官方文檔關於 markdown 的示例寫法，圖片不能在主頁正常顯示，但在文章中能正常顯示。此外，這種相對引用寫法在絕大數markdown 編輯器的預覽視圖中都無法正常顯示圖片（Typora 通過設置<code>Use Image Root Path</code> 可以解決，它會在文件頭添加<code>typora-root-url: xxxx </code>）。</p>
</li>
</ul>
<h2 id="標籤插件語法引用"><a href="#標籤插件語法引用" class="headerlink" title="# 標籤插件語法引用"></a># 標籤插件語法引用</h2><p>通過常規的MarkDown語法和相對路徑引用圖片或其它資源相對方便，但是這些包含相對位置引用資源的文章在首頁，或者存檔頁面不能正常顯示。 HEXO 3開始核心代碼中加入了相對路徑引用的標籤插件，用以解決這個問題。 （在HEXO 3之前許多開發者開發類似插件，現在被官方更新後核心代碼採用了）。</p>
<p>並且需要安裝插件，安裝方法為:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install https:&#x2F;&#x2F;github.com&#x2F;7ym0n&#x2F;hexo-asset-image --save</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 本地圖片資源，不限製圖片尺寸</span><br><span class="line">&#123;% asset_img image.jpg This is an image %&#125;</span><br><span class="line"># 網絡圖片資源，限製圖片顯示尺寸</span><br><span class="line">&#123;% img http:&#x2F;&#x2F;www.viemu.com&#x2F;vi-vim-cheat-sheet.gif 200 400 vi-vim-cheat-sheet %&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>&#123;% asset_img example.png example %&#125;</code></p>
<p>Hexo 官方推薦使用標籤的寫法，圖片能在主頁和文章中正常顯示，但是不能在 markdown 編輯器的預覽視圖中預覽圖片。</p>
</li>
</ul>
<h3 id="啟用fancybox：點擊查看圖片大圖"><a href="#啟用fancybox：點擊查看圖片大圖" class="headerlink" title="# 啟用fancybox：點擊查看圖片大圖"></a># 啟用fancybox：點擊查看圖片大圖</h3><p>我這裡使用的是Hexo的NexT主題，NexT主題中提供了fancybox的方便接口。</p>
<p>Usage：<a target="_blank" rel="noopener" href="https://github.com/theme-next/theme-next-fancybox3">https://github.com/theme-next/theme-next-fancybox3</a><br>markdown用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% img http:&#x2F;&#x2F;www.viemu.com&#x2F;vi-vim-cheat-sheet.gif 600 600 &quot;點擊查看圖片大圖:vi&#x2F;vim-cheat-sheet&quot; %&#125;</span><br></pre></td></tr></table></figure>



<h2 id="HTML語法引用（最終手段，一定能成，推薦）"><a href="#HTML語法引用（最終手段，一定能成，推薦）" class="headerlink" title="# HTML語法引用（最終手段，一定能成，推薦）"></a># HTML語法引用（最終手段，一定能成，推薦）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;image.png&quot; width&#x3D;&quot;50%&quot; height&#x3D;&quot;50%&quot; title&#x3D;&quot;image&quot; alt&#x3D;&quot;image&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p><mark>使用此方法要注意路徑</mark></p>
<p>config.yml文件中的配置項<code>post_asset_folder</code>設為<code>true</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tree source&#x2F;_posts </span><br><span class="line">source&#x2F;_posts</span><br><span class="line">├── Blog1</span><br><span class="line">│   └── image1.png</span><br><span class="line">└── Blog1.md</span><br><span class="line"></span><br><span class="line"># Blog1.md 中的 HTML語法引用</span><br><span class="line">&lt;img src&#x3D;&quot;.&#x2F;image1.png&quot; width&#x3D;&quot;50%&quot; height&#x3D;&quot;50%&quot; title&#x3D;&quot;image&quot; alt&#x3D;&quot;image&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8304172/tree-command-on-osx-bash">tree command on osx bash</a></p>
<h2 id="—Problem—"><a href="#—Problem—" class="headerlink" title="# —Problem—"></a># —Problem—</h2><p>問題推測</p>
<p>（一）本地圖片沒有有效上傳至github倉庫中，導致引用無效</p>
<p>解決方案：安裝外掛（回看前文）</p>
<p>（二）本地圖片沒有存放在同名資料夾中</p>
<p>解決方案：將需要引用的本地圖片存放在與文章名相同的資料夾中</p>
<p>（三）圖片路徑出錯</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="# reference"></a># reference</h2><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/asset-folders.html">資源文件夾</a></p>
<p><a target="_blank" rel="noopener" href="https://fuhailin.github.io/Hexo-images/">在Hexo博客中插入图片的各种方式</a></p>
<p><a target="_blank" rel="noopener" href="https://www.itread01.com/content/1542264790.html">hexo引用本地圖片無法顯示</a></p>
<p><a target="_blank" rel="noopener" href="https://hexo.io/zh-tw/docs/tag-plugins.html">標籤外掛（Tag Plugins）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32767041/article/details/103283522">Hexo 搭建个人博客（五）Hexo 资源文件夹</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">WongJY</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WongJY</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
