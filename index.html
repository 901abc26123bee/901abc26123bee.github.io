<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="WongJY Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="WongJY Blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Tina Wong">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-tw'
  };
</script>

  <title>WongJY Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LMFDSHYL3V"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LMFDSHYL3V');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LMFDSHYL3V"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LMFDSHYL3V');
</script>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WongJY Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/20/20240820-websocket-architecture-and-scaling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/20/20240820-websocket-architecture-and-scaling/" class="post-title-link" itemprop="url">WebSocket Usage Pattern in Microservices Architecture and How to Horizontal Scaling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-20 22:01:01" itemprop="dateCreated datePublished" datetime="2024-08-20T22:01:01+08:00">2024-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-23 23:51:28" itemprop="dateModified" datetime="2024-08-23T23:51:28+08:00">2024-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebSocket/" itemprop="url" rel="index"><span itemprop="name">WebSocket</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>To Be Continue…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/15/20240814-websocket-protocol-apiSchemaDesign-authentication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/15/20240814-websocket-protocol-apiSchemaDesign-authentication/" class="post-title-link" itemprop="url">Dig in WebSocket: Protocol, API Design, and Security</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-15 00:24:11" itemprop="dateCreated datePublished" datetime="2024-08-15T00:24:11+08:00">2024-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-23 00:25:03" itemprop="dateModified" datetime="2024-08-23T00:25:03+08:00">2024-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebSocket/" itemprop="url" rel="index"><span itemprop="name">WebSocket</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dig-in-WebSocket-Protocol-API-Design-and-Security"><a href="#Dig-in-WebSocket-Protocol-API-Design-and-Security" class="headerlink" title="Dig in WebSocket: Protocol, API Design, and  Security"></a>Dig in WebSocket: Protocol, API Design, and  Security</h1><h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>WebSocket operate at the Application layer in both the OSI(Layer 7) and TCP/IP(Layer 4) models.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> HTTP       WebSocket</span><br><span class="line">--------------------</span><br><span class="line">        TCP</span><br><span class="line">--------------------</span><br><span class="line">        IP</span><br><span class="line">--------------------</span><br><span class="line">Network access Layer</span><br></pre></td></tr></table></figure>

<p>The WebSocket protocol enables full-duplex communication, allowing data to be sent and received simultaneously over a single, persistent connection. This capability is ideal for real-time applications such as chat systems, live notifications, and online gaming.</p>
<h2 id="How-to-Establish-a-WebSocket-Connection"><a href="#How-to-Establish-a-WebSocket-Connection" class="headerlink" title="How to Establish a WebSocket Connection"></a>How to Establish a WebSocket Connection</h2><p>A WebSocket server is essentially an application that listens on any port of a TCP, following a designated protocol. A WebSocket connection starts with an HTTP handshake and then upgrades to a persistent TCP connection. Once this connection is established, it remains open for an extended period, allowing real-time communication between the client and server.</p>
<ol>
<li><p><strong>Client handshake request</strong></p>
<p> Client sent a HTTP request with method <code>GET</code> for upgrading the connection from HTTP to WebSocket.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/<span class="number">1.1</span></span><br><span class="line">Host: example.com:<span class="number">8000</span></span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Sec-WebSocket-Version: <span class="number">13</span></span><br></pre></td></tr></table></figure>

<ul>
<li>The <strong><code>Sec-WebSocket-Key</code></strong> header is used  to ensure that the client and server are speaking the WebSocket protocol.<br>  It is a base64 encoded value that is generated by randomly selecting 16-byte value as a nonce.</li>
<li>The <strong><code>Sec-WebSocket-Version</code></strong> header indicates the version of the WebSocket protocol that the client supports.</li>
<li>The HTTP version must be 1.1 or greater because earlier versions of HTTP do not support the necessary features for upgrading to WebSocket.</li>
<li>Origin header is supplied if the client is a web browser, and CORS issues must also be addressed.</li>
</ul>
</li>
</ol>
<ol start="2">
<li><p><strong>Server handshake response</strong></p>
<p> If the server supports WebSocket, it responds with an upgrade header, establishing a WebSocket connection. </p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></table></figure>

<ul>
<li><p> <strong><code>Sec-WebSocket-Accept</code></strong> = concatenate the client’s <code>Sec-WebSocket-Key</code> and the string “<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>“ together (it’s a “<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Magic_string">magic string</a>“), take the SHA-1 hash of the result, and return the base64 encoding of that hash.</p>
<p>The <code>Sec-WebSocket-Key</code> and <code>Sec-WebSocket-Accept</code> headers are part of the security mechanism to ensure that the WebSocket handshake is being conducted correctly and to prevent certain types of attacks.</p>
<ul>
<li>Protocol Upgrade Validation: confirms that the server has correctly understood the WebSocket handshake request(server indeed support WebSocket).</li>
<li>Security and Authentication: This value is used to ensure that the handshake request is valid and is not replayed by a malicious entity.</li>
</ul>
</li>
</ul>
</li>
</ol>
<ol start="3">
<li><p><strong>Exchanging data frames</strong></p>
<p> Websockets have four states: <code>connecting</code>, <code>open</code>, <code>closing</code> and <code>closed</code>. All communication between clients and servers takes place though the use of the websocket <code>frame</code>.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Frame format:</span><br><span class="line"></span><br><span class="line">      0                   1                   2                   3</span><br><span class="line">      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">    +-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">    |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">    |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">    |N|V|V|V|       |S|             |   (<span class="keyword">if</span> payload len==126/127)   |</span><br><span class="line">    | |1|2|3|       |K|             |                               |</span><br><span class="line">    +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">    |     Extended payload length continued, <span class="keyword">if</span> payload len == 127  |</span><br><span class="line">    + - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">    |                               |Masking-key, <span class="keyword">if</span> MASK <span class="built_in">set</span> to 1  |</span><br><span class="line">    +-------------------------------+-------------------------------+</span><br><span class="line">    | Masking-key (continued)       |          Payload Data         |</span><br><span class="line">    +-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">    :                     Payload Data continued ...                :</span><br><span class="line">    + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">    |                     Payload Data continued ...                |</span><br><span class="line">    +---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p> For more detail about each field: <a target="_blank" rel="noopener" href="https://ably.com/topic/websockets#how-do-web-sockets-work">The WebSocket API and protocol explained</a>, <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">rfc6455</a></p>
<ul>
<li>FIN bit: webSocket protocol makes fragmentation possible via this field, which indicates whether the frame is the final fragment in a WebSocket message.</li>
<li>Opcode: determines how to interpret the payload data.<ul>
<li>0: continuation frame; continues the payload from the previous frame.</li>
<li>1: text frame (UTF-8 text data).</li>
<li>2: binary frame.</li>
<li>8: connection close frame; leads to the connection being terminated.</li>
<li>9: ping frame</li>
<li>10: pong frame</li>
</ul>
</li>
<li>Mask, Masking key, (Extended) payload length, Payload data: Masking is applied from the client to the server to protect against specific security risks associated with WebSocket communication, such as cross-protocol attacks and interference by intermediaries. The server does not need to mask its messages to the client because the client is considered to be in a more secure and controlled environment, and masking would only add unnecessary overhead.</li>
</ul>
</li>
</ol>
<h2 id="Life-Cycle-and-Data-Flow"><a href="#Life-Cycle-and-Data-Flow" class="headerlink" title="Life Cycle and Data Flow"></a>Life Cycle and Data Flow</h2><p>Find a diagram shows how data flows between an websockets application and a remote endpoint. It applies regardless of which side is the server or the client.<br><a target="_blank" rel="noopener" href="https://websockets.readthedocs.io/en/stable/topics/design.html">Image From python websockets library doc</a></p>
<p>The WebSocket protocol uses PING/PONG messages to keep connections alive, even when operating behind proxies, firewalls, or load balancers. The server sends a PING message to the client, which responds with a PONG. If the client fails to respond, the server closes the connection.</p>
<img src="/2024/08/15/20240814-websocket-protocol-apiSchemaDesign-authentication/lifecycle.svg" title="Image from python websockets library doc" alt="Image from python websockets library doc">


<p>The following diagram shows how data flows between an application built on top of websockets and a remote endpoint. It applies regardless of which side is the server or the client.</p>
<img src="/2024/08/15/20240814-websocket-protocol-apiSchemaDesign-authentication/protocol.svg" title="Image from python websockets library doc" alt="Image from python websockets library doc">

<h2 id="Websocket-API-Design"><a href="#Websocket-API-Design" class="headerlink" title="Websocket API Design"></a>Websocket API Design</h2><p>The WebSocket protocol enables two-way communication between a client and server over a persistent connection without enforcing a specific message format. Messages can be sent in two primary formats:</p>
<ul>
<li>Text (String) Messages (Opcode 1): These are sent as UTF-8 encoded strings.</li>
<li>Binary (Blob) Messages (Opcode 2): These consist of binary data.</li>
</ul>
<p>Still, there are several API specification formats and standards that can be used for WebSockets, although they are less standardized compared to REST APIs. Here are some of the most commonly used formats:</p>
<ul>
<li><strong>AsyncAPI</strong> is the most comprehensive and purpose-built specification for WebSocket and other asynchronous APIs.</li>
<li><strong>OpenAPI (with Extensions)</strong> is useful if you want to keep WebSocket API documentation consistent with REST API documentation.</li>
<li><strong>WAMP</strong> is more of a protocol but includes its own specifications for WebSocket communication.</li>
<li><strong>RAML</strong> can be extended for WebSockets but is less common for this use case.</li>
<li>Custom Documentation Formats, ex: <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  &quot;type&quot;: &quot;message_type&quot;,</span></span><br><span class="line"><span class="comment">  &quot;payload&quot;: &#123;</span></span><br><span class="line"><span class="comment">      // payload</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  &quot;timestamp&quot;: &quot;2024-08-15T12:34:56Z&quot;,</span></span><br><span class="line"><span class="comment">  &quot;meta&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;source&quot;: &quot;client_id&quot;,</span></span><br><span class="line"><span class="comment">      &quot;destination&quot;: &quot;room_id&quot;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleWebSocketStreamConnectMessage</span><span class="params">(ctx context.Context, msgReq StreamWSMessageRequest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> msgReq.Type &#123;</span><br><span class="line">  <span class="keyword">case</span> WSMessageTypeChatRoomAction:</span><br><span class="line">    <span class="keyword">var</span> actionPayload ChatRoomActionRequest</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(msgReq.Payload, &amp;actionPayload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// handling action</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> WSMessageTypeChat:</span><br><span class="line">    <span class="keyword">var</span> chatMsgPayload ChatRoomMessageRequest</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(msgReq.Payload, &amp;chatMsgPayload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// handle message</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="WebSocket-Security"><a href="#WebSocket-Security" class="headerlink" title="WebSocket Security"></a>WebSocket Security</h2><h3 id="WSS"><a href="#WSS" class="headerlink" title="WSS"></a>WSS</h3><p>Use secure <code>wss://</code> protocol over the vulnerable <code>ws://</code> transport,  similar to the preference for <code>https://</code> over <code>http://</code>. WSS encrypts WebSocket connections, safeguarding against man-in-the-middle attacks.</p>
<h3 id="Validate-Transported-message"><a href="#Validate-Transported-message" class="headerlink" title="Validate Transported message"></a>Validate Transported message</h3><p>Validate client message before processing it to avoid SQL injection, and validate server message to avoid unexpected errors.</p>
<h3 id="Authentication-Authorization"><a href="#Authentication-Authorization" class="headerlink" title="Authentication/Authorization"></a>Authentication/Authorization</h3><ol>
<li><p>Send Access Token in the Query Parameter</p>
<p> Unlike HTTP, which mandates authentication credentials for each request, WebSockets establish a persistent connection. Authentication occurs during the initial HTTP handshake before the connection is upgraded to WebSocket, allowing subsequent communication without repeated credential checks.</p>
   <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wss://website.com?token=your_token_here</span><br></pre></td></tr></table></figure>
<p> If the token is valid, proceed with the WebSocket upgrade. Otherwise, send a standard 401 Unauthorized response and close the underlying socket.</p>
</li>
<li><p>Send Access Token Over WebSocket<br> Another way to authenticate a WebSocket connection is to send the access token in the first message after establishing the connection. The server should validate the token before allowing any client actions.<br> However, this approach has drawbacks:</p>
<ul>
<li><p>Increased Complexity: Implementing a custom stateful protocol adds complexity, requiring session management, synchronization across scales, and addressing inconsistencies. If issues arise, it could block logins or introduce security vulnerabilities.</p>
</li>
<li><p>Vulnerability to DoS Attacks: Attackers might open multiple WebSocket connections without authenticating, tying up server resources. This requires strict timeouts to prevent server overload, adding more complexity compared to HTTP-based methods.</p>
</li>
</ul>
</li>
</ol>
<h2 id="Graceful-Degradation"><a href="#Graceful-Degradation" class="headerlink" title="Graceful Degradation"></a><strong>Graceful Degradation</strong></h2><ul>
<li><strong>Fallback Mechanisms:</strong> In scenarios where maintaining a WebSocket connection is difficult (e.g., due to network issues or server overload) or not supported by client devices (<a target="_blank" rel="noopener" href="https://caniuse.com/websockets">Can I use WebSocket?</a>), applications often implement fallback mechanisms like HTTP long polling or Server-Sent Events (SSE). These alternatives can help maintain communication, albeit less efficiently, when WebSockets are not viable.</li>
</ul>
<h2 id="Sec-WebSocket-Extensions"><a href="#Sec-WebSocket-Extensions" class="headerlink" title="Sec-WebSocket-Extensions"></a>Sec-WebSocket-Extensions</h2><p>check <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">Protocol upgrade mechanism</a>for more detail</p>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ul>
<li><a target="_blank" rel="noopener" href="https://ably.com/topic/websockets">The WebSocket API and protocol explained</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">Writing WebSocket servers</a></li>
<li><a target="_blank" rel="noopener" href="https://websockets.readthedocs.io/en/stable/topics/design.html">Design</a></li>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">rfc6455</a></li>
<li><a target="_blank" rel="noopener" href="https://noio-ws.readthedocs.io/en/latest/overview_of_websockets.html">overview_of_websockets</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.to/idanarye/are-there-any-api-specification-formats-for-websockets-2mkk">Are there any API specification formats for WebSockets?</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications">Writing_WebSocket_client_applications</a></li>
<li><a target="_blank" rel="noopener" href="https://ably.com/blog/websocket-authentication">websocket-authentication</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/67487034/how-to-do-authentication-over-web-sockets">how-to-do-authentication-over-web-sockets</a></li>
<li><a target="_blank" rel="noopener" href="https://pages.ably.com/hubfs/the-websocket-handbook.pdf">the-websocket-handbook</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/websockets-in-microservices-architecture/">websockets-in-microservices-architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/websocket-security">WebSocket Security</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31564432/websocket-security">Websocket Security</a></li>
<li><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/web-cache-poisoning">web cache poisoning</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">Protocol upgrade mechanism</a></li>
<li><a target="_blank" rel="noopener" href="https://caniuse.com/websockets">Can I use WebSocket?</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/26/Unveiling-HTTPS-The-Roles-of-PKCS-Digital-Certificates-Public-Key-Infrastructure-and-Chain-of-Trust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/26/Unveiling-HTTPS-The-Roles-of-PKCS-Digital-Certificates-Public-Key-Infrastructure-and-Chain-of-Trust/" class="post-title-link" itemprop="url">Unveiling HTTPS: The Roles of PKCS, Digital Certificates, Public Key Infrastructure, and Chain of Trust</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-26 22:00:11" itemprop="dateCreated datePublished" datetime="2024-06-26T22:00:11+08:00">2024-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-23 00:09:36" itemprop="dateModified" datetime="2024-08-23T00:09:36+08:00">2024-08-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In network communications, we often need to protect the content of our messages, and this is done by hiding the original content through encryption. HTTPS (HyperText Transfer Protocol Secure) uses a combination of symmetric and asymmetric encryption to ensure secure communication over the internet. Here’s how it works:</p>
<ol>
<li><p>TCP Handshake: The initial connection between the client and server is established using TCP (Transmission Control Protocol). This handshake ensures a reliable connection.</p>
</li>
<li><p>SSL/TLS Handshake:</p>
<ul>
<li>Client Hello: The client sends a message indicating its support for SSL/TLS version and set of necessary encryption algorithms (cipher suites) it prefers.</li>
<li>Server Hello: The server responds so let browser knows whether it can support the algorithms and TLS version. The server then sends the SSL certificate to the client. The certificate contains the public key, hostname, expiry dates, etc.</li>
<li>Certificate Verification: The client verifies the server’s certificate to ensure it belongs to the intended party.</li>
<li>Key Exchange: The client uses this public key(parse from certificate) to encrypt a randomly generated session key.</li>
<li>Finished: Now that both the client and the server hold the same session key (symmetric encryption),.</li>
</ul>
</li>
<li><p>Data Encryption:</p>
<ul>
<li>Symmetric Encryption: All subsequent data is encrypted using the shared secret key. This is much faster than asymmetric encryption and is ideal for large amounts of data.</li>
</ul>
</li>
</ol>
<h2 id="Symmetric-Encryption"><a href="#Symmetric-Encryption" class="headerlink" title="Symmetric Encryption"></a>Symmetric Encryption</h2><p>Symmetric-key algorithms are algorithms for cryptography that use the same cryptographic keys for both the encryption of plaintext and the decryption of ciphertext. The key represent a shared secret between two or more parties that can be used to maintain a private information link.</p>
<ul>
<li><p>Example Algorithms: AES (Advanced Encryption Standard), DES (Data Encryption Standard). </p>
</li>
<li><p>For more Algorithms and their difference, reference: <a target="_blank" rel="noopener" href="https://cryptobook.nakov.com/symmetric-key-ciphers/popular-symmetric-algorithms">Popular Symmetric Algorithms</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm">Symmetric-key algorithm</a></p>
</li>
</ul>
<p>This solution appears ideal, but there’s a significant issue: how can multiple parties agree on the encryption key? If the key is transmitted over the network, it could be intercepted by hackers. Consequently, symmetric encryption is perpetually caught in this dilemma. This is where asymmetric encryption becomes essential.</p>
<h2 id="Asymmetric-Encryption-Public-key-cryptography"><a href="#Asymmetric-Encryption-Public-key-cryptography" class="headerlink" title="Asymmetric Encryption(Public key cryptography)"></a>Asymmetric Encryption(Public key cryptography)</h2><p>Asymmetric Encryption use pairs of related keys. Each key pair consists of a public key and a corresponding private key. Anyone with a public key can encrypt a message, yielding a ciphertext, but only those who know the corresponding private key can decrypt the ciphertext to obtain the original message.</p>
<ul>
<li><p>Example Algorithms: RSA (Rivest-Shamir-Adleman), ECC (Elliptic Curve Cryptography).</p>
</li>
<li><p>For more Algorithms and their difference, reference: <a target="_blank" rel="noopener" href="https://dev.digicert.com/en/trustcore-sdk/nanocrypto/asymmetric-algorithms.html">Asymmetric Algorithms</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Public-key_cryptography">Public-key cryptography</a></p>
</li>
</ul>
<h2 id="PKCS-Public-Key-Cryptography-Standards"><a href="#PKCS-Public-Key-Cryptography-Standards" class="headerlink" title="PKCS(Public Key Cryptography Standards)"></a>PKCS(Public Key Cryptography Standards)</h2><p>Public Key Cryptography Standards (PKCS) are protocols that structure various aspects of using public key infrastructure for information exchange. It includes standards for key exchange, password-based encryption, cryptographic messaging, private key information, certification requests, cryptographic tokens, and personal information exchange.</p>
<p>RSA, a fundamental cryptographic algorithm, is utilized within various PKCS standards to ensure secure and standardized implementation of public key cryptography. As one of the first public key cryptosystems, the RSA algorithm is widely used for secure data transmission and underpins many protocols within the PKCS suite.</p>
<p><strong>Some PKCS Standards Related To RSA</strong>:</p>
<ul>
<li><p><strong>PKCS #1 RSA Cryptography Standard</strong>:</p>
<p>  This is the a standard specifically for RSA cryptography. It defines the mathematical properties and formats for RSA public and private keys, as well as the encryption and signature schemes based on RSA. It includes details on padding schemes (such as OAEP and PSS) to ensure the security of RSA operations. </p>
<ul>
<li><strong>PKCS #1 v1.5</strong>  and <strong>PKCS #1 v2.0(OAEP)</strong>  are the primary padding schemes for RSA encryption, RSA can be used with various padding schemes, particularly in the context of digital signatures. OAEP is generally preferred for its stronger security properties</li>
<li>Standard RSA private key decryption involves removing all padding or encoding from the ciphertext, resulting in the plaintext as it was originally encrypted. Prior to decryption, it is essential to determine the specific padding mode used during encryption. Additionally, the length of the input to any RSA decryption method must match the size of the RSA key in bytes (i.e., the modulus size in bytes).  For OAEP (Optimal Asymmetric Encryption Padding), it is also crucial to know which hash functions were used during the encoding process.</li>
</ul>
</li>
<li><p><strong>PKCS #7 Cryptographic Message Syntax Standard</strong>:</p>
<p>  This standard defines a general syntax for data that may have cryptography applied to it, such as digital signatures and encryption. RSA is often used within PKCS #7 for signing and encrypting messages.</p>
</li>
<li><p><strong>PKCS #8 Private-Key Information Syntax Standard</strong>:<br>  This is a more versatile standard for storing private keys. It defines the structure for private key information and supports a variety of key types, including RSA, DSA, and ECDSA. The standard specifies how private keys should be encoded and securely stored.</p>
</li>
<li><p><strong>PKCS #10 Certification Request Standard:</strong></p>
<p>  This standard is used when applying for a digital certificate from a certificate authority.</p>
</li>
<li><p><strong>PKCS #12 Personal Information Exchange Syntax Standard</strong>:</p>
<p>  This standard defines how to securely store and transport a user’s private keys, certificates, and other related information. It is used extensively for exporting and importing digital certificates.</p>
</li>
</ul>
<p>More PKCS details:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2018/04/21/PKI-Digital-Certificate-Format-Convertion-Notes">認識 PKI 架構下的數位憑證格式與憑證格式轉換的心得分享</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PKCS">wiki PKCS</a></li>
<li><a target="_blank" rel="noopener" href="https://www.spiceworks.com/it-security/network-security/articles/what-is-pkcs/">What are Public Key Cryptography Standards (PKCS)? Meaning, Specifications, and Importance</a></li>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc8017">IETF DataTracker PKCS #1: RSA Cryptography Specifications Version 2.2</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48958304/pkcs1-and-pkcs8-format-for-rsa-private-key">PKCS#1 and PKCS#8 format for RSA private key</a></li>
</ul>
<p>Asymmetric encryption also encounters a similar challenge: how do you share the public key with the other party? One approach is to post it on a public web address for the other party to download; another is to send it during the connection establishment. Both methods share a common problem: how do you verify that the public key you received is legitimate? Could someone impersonate the website and provide you with their own public key?</p>
<p>This is where Public Key Infrastructure (PKI) and Digital certificate(Public key certificates) comes in.</p>
<h2 id="Public-Key-Infrastructure-PKI"><a href="#Public-Key-Infrastructure-PKI" class="headerlink" title="Public Key Infrastructure (PKI)"></a>Public Key Infrastructure (PKI)</h2><p>A Public Key Infrastructure (PKI) is a system that binds public keys with the identities of entities such as individuals and organizations. This binding is achieved through a registration and certificate issuance process conducted by a trusted entity known as a Certificate Authority (CA). Depending on the security requirements, this process can be automated or involve human oversight.</p>
<p>PKI provides essential “trust services,” which essentially means trusting the actions or outputs of entities, whether they are people or computers. These trust services aim to achieve one or more of the following objectives: Confidentiality, Integrity, and Authenticity (often abbreviated as CIA).</p>
<p>Here’s an overview of what is involved in PKI:</p>
<ul>
<li><strong>Certificate Authority (CA):</strong> An entity that stores, issues, and signs digital certificates.</li>
<li><strong>Registration Authority (RA):</strong> An entity that verifies the identities of entities (individuals, organizations, applications, etc.) requesting certificates.</li>
<li><strong>Central Directory:</strong> A repository where keys are stored and retrieved.</li>
<li><strong>Certificate Management System:</strong> A system that manages the lifecycle of certificates, including issuance, access, and delivery.</li>
<li><strong>Certificate Policy:</strong> A set of rules that defines the procedures for managing certificates and keys within the PKI framework, ensuring their security.</li>
</ul>
<p>For more detailed information: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Public_key_infrastructure">Wikipedia page on Public Key Infrastructure</a>.</p>
<p>Now that you understand what a PKI (Public Key Infrastructure) is, let’s delve into how you can request digital certificates and authenticate them.</p>
<h2 id="Digital-certificate-Public-key-certificates"><a href="#Digital-certificate-Public-key-certificates" class="headerlink" title="Digital certificate (Public key certificates)"></a>Digital certificate (Public key certificates)</h2><h3 id="Generating-a-Key-Pair"><a href="#Generating-a-Key-Pair" class="headerlink" title="Generating a Key Pair"></a>Generating a Key Pair</h3><p>First, generate a pair of cryptographic keys—a public key and a private key. The public key is shared openly, while the private key is kept secure and known only to you.</p>
<ol>
<li>generate private key</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NOTICE: kept private key secure</span></span><br><span class="line">$ openssl genrsa -out yoursite_private.key 1024</span><br><span class="line">$ cat yoursite_private.key</span><br><span class="line"></span><br><span class="line">-----BEGIN PRIVATE KEY-----</span><br><span class="line">MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAKLp3YaO0SuRvokz</span><br><span class="line">DD91tVnY0wxQI3powVlV0EcXX19t2CcCYu2glkYTKqGdpECY1iV2QQXBZiZ2dx5N</span><br><span class="line">TRfVllYv4ThLhOydUjFGWL0+z1FbwkyyUYusyRbkpc7xG2oZ/UijFM8y47LqKIzK</span><br><span class="line">C5sqSsrxESR4csGkljkp7KTHtT4jAgMBAAECgYA4JbfmlzQ5+uobKQ/Qk0XkaFkc</span><br><span class="line">hkYj+xSgMHYu+jwxjI8Rqr3jvhPspNBtkQI6DTLJCH+Sdzw4h124gNXQIBnGn4kt</span><br><span class="line">K9FadXSJRpqnulhEkPkA/NyAcKHzjm4GpWa5bA5+BrLJScBq00VK6cmhXfP3jFSJ</span><br><span class="line">D4nZd+4Eck9wvaGGOQJBANiIghGCKQ3q3BUig1S3NXRHVDp69j8T+cDstNuvK1Wp</span><br><span class="line">+dMjpbzWOhloRK0ieCdVa0TRXhaylPuomNpI4m1hjO8CQQDAm3MPyS8toCz0ggkH</span><br><span class="line">9Y2DVqJmTI4vQ6in+9Lya1z2iSp2Tc5Lyqm/ZcFc1uBCYSdoYWX5cgEMoKRJHNPx</span><br><span class="line">PEoNAkEAkc4J14RP5ME7BThCOu9LHUtSmjZmTj9DM/ewKSWhBoP4Z4ZfefK/GJCv</span><br><span class="line">fe3x/np0Sti4hIwn6fWzR3lAjurbHQJAVqOWVnuBJVzv2+zCczoZtgK6epnlO42L</span><br><span class="line">yESW10VERAHff+fv7Ff1k4sKN+DQcAuT1ng5jsOhhTSdseWt0M314QJBAMTFneqp</span><br><span class="line">vO4QEmhHHhf4vqAiZ16IpTRl4XgfN50gpr+GoHshVSdxsk1cW3dTH2pNoiVBL56R</span><br><span class="line">esjnNHpPWmkIJME=</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>generate public key from private key</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -<span class="keyword">in</span> yoursite_private.key -pubout -out yoursite_public.pem</span><br><span class="line">$ cat yoursite_public.key</span><br><span class="line"></span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCi6d2GjtErkb6JMww/dbVZ2NMM</span><br><span class="line">UCN6aMFZVdBHF19fbdgnAmLtoJZGEyqhnaRAmNYldkEFwWYmdnceTU0X1ZZWL+E4</span><br><span class="line">S4TsnVIxRli9Ps9RW8JMslGLrMkW5KXO8RtqGf1IoxTPMuOy6iiMygubKkrK8REk</span><br><span class="line">eHLBpJY5Keykx7U+IwIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Then you can encrypt and decrypt a message by pair of cryptographic keys.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PKCS#1 v2.0(RSA-OAEP)</span></span><br><span class="line"><span class="comment"># encrypt</span></span><br><span class="line">openssl pkeyutl -encrypt -<span class="keyword">in</span> plaintext.txt -pubin -inkey yoursite_public.pem -pkeyopt rsa_padding_mode:oaep -out ciphertext.bin</span><br><span class="line"><span class="comment"># decrypt</span></span><br><span class="line">openssl pkeyutl -decrypt -<span class="keyword">in</span> ciphertext.bin -inkey yoursite_private.key -pkeyopt rsa_padding_mode:oaep -out decrypted.txt</span><br></pre></td></tr></table></figure>

<p>Since that every entity can generate their own key pair, how can others verify that this key pair indeed represents your identity? This is where the involvement of authoritative bodies becomes crucial. A third-party validation authority (VA) can provide the necessary entity information on behalf of the certification authority (CA).</p>
<h3 id="Generate-Certificate-Signing-Request-CSR"><a href="#Generate-Certificate-Signing-Request-CSR" class="headerlink" title="Generate Certificate Signing Request (CSR):"></a>Generate Certificate Signing Request (CSR):</h3><p>A CSR includes your public key and information about your identity. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run the OpenSSL command to generate the CSR:</span></span><br><span class="line">$ openssl req -new -key yoursite_private.key -out yoursite.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:TW</span><br><span class="line">State or Province Name (full name) [Some-State]:Taipei</span><br><span class="line">Locality Name (eg, city) []:Taipai</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:YourSite</span><br><span class="line">Organizational Unit Name (eg, section) []:Test</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:Test</span><br><span class="line">Email Address []:<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">Please enter the following <span class="string">&#x27;extra&#x27;</span> attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:<span class="built_in">test</span></span><br><span class="line">An optional company name []:<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ cat yoursite.csr</span><br><span class="line"></span><br><span class="line">-----BEGIN CERTIFICATE REQUEST-----</span><br><span class="line">MIIB3zCCAUgCAQAwdTELMAkGA1UEBhMCVFcxDzANBgNVBAgMBlRhaXBlaTEPMA0G</span><br><span class="line">A1UEBwwGVGFpcGFpMREwDwYDVQQKDAhZb3VyU2l0ZTENMAsGA1UECwwEVGVzdDEN</span><br><span class="line">MAsGA1UEAwwEVGVzdDETMBEGCSqGSIb3DQEJARYEdGVzdDCBnzANBgkqhkiG9w0B</span><br><span class="line">AQEFAAOBjQAwgYkCgYEAoundho7RK5G+iTMMP3W1WdjTDFAjemjBWVXQRxdfX23Y</span><br><span class="line">JwJi7aCWRhMqoZ2kQJjWJXZBBcFmJnZ3Hk1NF9WWVi/hOEuE7J1SMUZYvT7PUVvC</span><br><span class="line">TLJRi6zJFuSlzvEbahn9SKMUzzLjsuoojMoLmypKyvERJHhywaSWOSnspMe1PiMC</span><br><span class="line">AwEAAaAqMBMGCSqGSIb3DQEJAjEGDAR0ZXN0MBMGCSqGSIb3DQEJBzEGDAR0ZXN0</span><br><span class="line">MA0GCSqGSIb3DQEBCwUAA4GBACl5YxcubqBt9HQ6sA0+M40xf8EyU+/xYYxi7j7p</span><br><span class="line">LqWMAupBsbicX3zsB7dP8AuT2cQkbCt6AGzuPyLA2aDSlcY1a7f4LbpMIP268LPs</span><br><span class="line">zGTFGbQGM+Y2xh7uPBZyF7FJOlX//usRnzDsss8OLoCgHxNomIwvFKWvemxB2k/a</span><br><span class="line">jtgC</span><br><span class="line">-----END CERTIFICATE REQUEST-----</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify the CSR: you can inspect the contents of the CSR to ensure that the information is correct:</span></span><br><span class="line">$ openssl req -<span class="keyword">in</span> yoursite.csr -noout -text</span><br><span class="line"></span><br><span class="line">Certificate Request:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 1 (0x0)</span><br><span class="line">        Subject: C=TW, ST=Taipei, L=Taipai, O=YourSite, OU=Test, CN=Test, emailAddress=<span class="built_in">test</span></span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (1024 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a2:e9:dd:86:8e:d1:2b:91:be:89:33:0c:3f:75:</span><br><span class="line">                    b5:59:d8:d3:0c:50:23:7a:68:c1:59:55:d0:47:17:</span><br><span class="line">                    5f:5f:6d:d8:27:02:62:ed:a0:96:46:13:2a:a1:9d:</span><br><span class="line">                    a4:40:98:d6:25:76:41:05:c1:66:26:76:77:1e:4d:</span><br><span class="line">                    4d:17:d5:96:56:2f:e1:38:4b:84:ec:9d:52:31:46:</span><br><span class="line">                    58:bd:3e:cf:51:5b:c2:4c:b2:51:8b:ac:c9:16:e4:</span><br><span class="line">                    a5:ce:f1:1b:6a:19:fd:48:a3:14:cf:32:e3:b2:ea:</span><br><span class="line">                    28:8c:ca:0b:9b:2a:4a:ca:f1:11:24:78:72:c1:a4:</span><br><span class="line">                    96:39:29:ec:a4:c7:b5:3e:23</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        Attributes:</span><br><span class="line">            unstructuredName         :<span class="built_in">test</span></span><br><span class="line">            challengePassword        :<span class="built_in">test</span></span><br><span class="line">            Requested Extensions:</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">    Signature Value:</span><br><span class="line">        29:79:63:17:2e:6e:a0:6d:f4:74:3a:b0:0d:3e:33:8d:31:7f:</span><br><span class="line">        c1:32:53:ef:f1:61:8c:62:ee:3e:e9:2e:a5:8c:02:ea:41:b1:</span><br><span class="line">        b8:9c:5f:7c:ec:07:b7:4f:f0:0b:93:d9:c4:24:6c:2b:7a:00:</span><br><span class="line">        6c:ee:3f:22:c0:d9:a0:d2:95:c6:35:6b:b7:f8:2d:ba:4c:20:</span><br><span class="line">        fd:ba:f0:b3:ec:cc:64:c5:19:b4:06:33:e6:36:c6:1e:ee:3c:</span><br><span class="line">        16:72:17:b1:49:3a:55:ff:fe:eb:11:9f:30:ec:b2:cf:0e:2e:</span><br><span class="line">        80:a0:1f:13:68:98:8c:2f:14:a5:af:7a:6c:41:da:4f:da:8e:</span><br><span class="line">        d8:02</span><br></pre></td></tr></table></figure>

<p>After running these steps, you’ll have a <code>yoursite.csr</code> file that you can submit to a Certificate Authority (CA) to obtain an SSL/TLS certificate.</p>
<p>A Certificate Authority (CA) may run below command to generate Certificate.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -<span class="keyword">in</span> yoursite.csr -CA cacertificate.pem -CAkey caprivate.key -out yoursite.pem</span><br></pre></td></tr></table></figure>

<p>Reference:</p>
<ul>
<li>Explains the various ways in which RSA keys can be stored:  <a target="_blank" rel="noopener" href="https://www.cryptosys.net/pki/rsakeyformats.html">RSA Key Formats</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/63195304/difference-between-pem-crt-key-files">Difference between pem, crt, key files</a></li>
</ul>
<h3 id="Self-signed-certificate"><a href="#Self-signed-certificate" class="headerlink" title="Self-signed certificate"></a>Self-signed certificate</h3><p>For for testing or internal use, you can also generate self-signed certificate using OpenSSL, you’ll need both a private key and a certificate signing request (CSR). However, you can generate a self-signed certificate directly without a CSR. Here’s how to do it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -x509 -key yoursite_private.key -out yoursite_certificate.crt -days 365</span><br><span class="line">$ openssl x509 -<span class="keyword">in</span> yoursite_certificate.crt -text -noout</span><br><span class="line"></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            3d:b5:59:d5:c9:77:54:96:91:d4:9f:c3:27:f4:34:8a:58:a3:2a:3a</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=TW, ST=Taipei, L=Taipei, O=YourSite</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Jun 26 01:58:40 2024 GMT</span><br><span class="line">            Not After : Jun 26 01:58:40 2025 GMT</span><br><span class="line">        Subject: C=TW, ST=Taipei, L=Taipei, O=YourSite</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (1024 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a2:e9:dd:86:8e:d1:2b:91:be:89:33:0c:3f:75:</span><br><span class="line">                    b5:59:d8:d3:0c:50:23:7a:68:c1:59:55:d0:47:17:</span><br><span class="line">                    5f:5f:6d:d8:27:02:62:ed:a0:96:46:13:2a:a1:9d:</span><br><span class="line">                    a4:40:98:d6:25:76:41:05:c1:66:26:76:77:1e:4d:</span><br><span class="line">                    4d:17:d5:96:56:2f:e1:38:4b:84:ec:9d:52:31:46:</span><br><span class="line">                    58:bd:3e:cf:51:5b:c2:4c:b2:51:8b:ac:c9:16:e4:</span><br><span class="line">                    a5:ce:f1:1b:6a:19:fd:48:a3:14:cf:32:e3:b2:ea:</span><br><span class="line">                    28:8c:ca:0b:9b:2a:4a:ca:f1:11:24:78:72:c1:a4:</span><br><span class="line">                    96:39:29:ec:a4:c7:b5:3e:23</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                42:37:D1:41:A1:BC:B9:12:61:76:FE:F4:BD:80:F3:6D:96:75:21:FC</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                42:37:D1:41:A1:BC:B9:12:61:76:FE:F4:BD:80:F3:6D:96:75:21:FC</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">    Signature Value:</span><br><span class="line">        33:f3:3f:5f:9c:63:a0:10:1e:90:d1:50:4e:d3:e2:6f:19:24:</span><br><span class="line">        98:41:57:65:32:48:a5:89:4e:b3:ea:25:95:8b:d0:ee:44:5e:</span><br><span class="line">        28:b1:1c:3d:65:3e:37:95:e0:<span class="built_in">cd</span>:6e:7b:2f:5c:8a:02:4e:99:</span><br><span class="line">        df:42:8b:a7:6b:f7:23:b4:47:15:7e:93:a5:8f:91:e8:29:21:</span><br><span class="line">        56:5a:f9:ab:9f:a1:24:d7:cf:5a:40:aa:57:02:30:a5:db:be:</span><br><span class="line">        2d:b1:c8:53:6c:14:86:9c:2b:a4:7e:0e:84:ff:53:a7:1b:02:</span><br><span class="line">        28:27:ca:4a:63:70:c0:de:84:33:66:f7:d9:aa:a0:b3:ba:80:</span><br><span class="line">        f8:8a</span><br></pre></td></tr></table></figure>

<p>the contents of this certificate:</p>
<ul>
<li>Issuer: This indicates who issued the certificate.</li>
<li>Subject: Specifies to whom the certificate was issued.</li>
<li>Validity: Indicates the duration of validity for the certificate.</li>
<li>Public Key: Contains the content of the public key.</li>
<li>Signature Algorithm: Specifies the algorithm used for signing.</li>
</ul>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2019/02/25/Creating-Self-signed-Certificate-using-OpenSSL">如何使用 OpenSSL 建立開發測試用途的自簽憑證 (Self-Signed Certificate)</a></li>
</ul>
<h3 id="Digital-signature"><a href="#Digital-signature" class="headerlink" title="Digital signature"></a>Digital signature</h3><p>A digital signature is a cryptographic mechanism used to verify the authenticity and integrity of a message, software, or digital document. It functions like a handwritten signature or a stamped seal, but it is much more secure.</p>
<p>When we submit a certificate request to a Certificate Authority (CA), the CA will sign the certificate. This process is known as the signature algorithm. But how can we ensure that the signature is indeed from the CA? The answer lies in using something that only the CA privately owns, which is the CA’s private key.</p>
<p>For example, if Google needs to prove to users that it is indeed Google, it must find a reliable CA. The CA’s staff will verify various documents and proofs of identity and then issue a digital certificate for Google.</p>
<p>Finally, this certificate contains all of Google’s identity information and a digital signature signed by the CA.</p>
<ul>
<li><p>The digital signature algorithm works as follows:</p>
<ul>
<li><p><strong>Signing</strong>: A certificate contains three parts: certificate content, hash algorithm, and encrypted ciphertext. The certificate content is hashed using the hash algorithm to produce a hash value, which is then encrypted using the private key provided by the CA institution.</p>
</li>
<li><p><strong>Verification</strong>: This certificate has an issuing authority, the CA. You just need to obtain the public key of this CA and use it to decrypt the signature part in certificate. If the decryption is successful and the hash matches, it means that the certificate is valid.</p>
</li>
</ul>
<img src="/2024/06/26/Unveiling-HTTPS-The-Roles-of-PKCS-Digital-Certificates-Public-Key-Infrastructure-and-Chain-of-Trust/Digital_Signature_diagram_svg.png" width="70%" height="70%" title="Digital_Signature_diagram" alt="https://io.wikipedia.org/wiki/Bica_signato#/media/Arkivo:Digital_Signature_diagram.svg">

</li>
</ul>
<p>Reference</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Digital_signature">Digital Signature</a></li>
</ul>
<h2 id="Chain-Of-Trust"><a href="#Chain-Of-Trust" class="headerlink" title="Chain Of Trust"></a><strong>Chain Of Trust</strong></h2><p>The main difference between a CA-signed certificate and a self-signed certificate is that a self-signed certificate contains a single CERTIFICATE block, whereas a CA-signed certificate contains multiple CERTIFICATE blocks.</p>
<ul>
<li>Self-signed certificate contains a single CERTIFICATE block, encompassing all necessary information such as the public key, identity details, and digital signature. While self-signed certificates can be convenient for testing or internal use, they lack the endorsement of a trusted third party, which is essential for establishing widespread trust in the certificate’s authenticity.</li>
<li>On the other hand,  CA-signed certificates are issued and signed by a trusted Certificate Authority. These certificates typically include multiple CERTIFICATE blocks within a chain. The primary CERTIFICATE block represents the certificate being issued (end-entity certificate), while subsequent blocks (intermediate certificates) link the end-entity certificate to the root certificate of the CA. This chain of certificates forms the basis of the “chain of trust,” where each certificate in the chain is validated against the next until the root CA certificate is reached.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># self signed contains single CERTIFICATE block</span></span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIICYDCCAcmgAwIBAgIUPbVZ1cl3VJaR1J/DJ/Q0ilijKjowDQYJKoZIhvcNAQEL</span><br><span class="line">BQAwQjELMAkGA1UEBhMCVFcxDzANBgNVBAgMBlRhaXBlaTEPMA0GA1UEBwwGVGFp</span><br><span class="line">cGVpMREwDwYDVQQKDAhZb3VyU2l0ZTAeFw0yNDA2MjYwMTU4NDBaFw0yNTA2MjYw</span><br><span class="line">MTU4NDBaMEIxCzAJBgNVBAYTAlRXMQ8wDQYDVQQIDAZUYWlwZWkxDzANBgNVBAcM</span><br><span class="line">BlRhaXBlaTERMA8GA1UECgwIWW91clNpdGUwgZ8wDQYJKoZIhvcNAQEBBQADgY0A</span><br><span class="line">MIGJAoGBAKLp3YaO0SuRvokzDD91tVnY0wxQI3powVlV0EcXX19t2CcCYu2glkYT</span><br><span class="line">KqGdpECY1iV2QQXBZiZ2dx5NTRfVllYv4ThLhOydUjFGWL0+z1FbwkyyUYusyRbk</span><br><span class="line">pc7xG2oZ/UijFM8y47LqKIzKC5sqSsrxESR4csGkljkp7KTHtT4jAgMBAAGjUzBR</span><br><span class="line">MB0GA1UdDgQWBBRCN9FBoby5EmF2/vS9gPNtlnUh/DAfBgNVHSMEGDAWgBRCN9FB</span><br><span class="line">oby5EmF2/vS9gPNtlnUh/DAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUA</span><br><span class="line">A4GBADPzP1+cY6AQHpDRUE7T4m8ZJJhBV2UySKWJTrPqJZWL0O5EXiixHD1lPjeV</span><br><span class="line">4M1uey9cigJOmd9Ci6dr9yO0RxV+k6WPkegpIVZa+aufoSTXz1pAqlcCMKXbvi2x</span><br><span class="line">yFNsFIacK6R+DoT/U6cbAignykpjcMDehDNm99mqoLO6gPiK</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line"><span class="comment"># CA signed contains multiple CERTIFICATE block</span></span><br><span class="line"></span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">[End-entity Certificate]</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">[Intermediate Certificate 1]</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">[Intermediate Certificate 2]</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">[Root Certificate]</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<p>The chain of trust is critical in ensuring the integrity and security of digital communications. By relying on CA-signed certificates and their associated chains, users can verify the legitimacy of a certificate without directly verifying the identity of the entity themselves. This process helps prevent various security threats, including man-in-the-middle attacks and unauthorized access.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/13/How-to-Implement-Custom-GORM-Logger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/13/How-to-Implement-Custom-GORM-Logger/" class="post-title-link" itemprop="url">How to Implement Custom GORM Logger</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-06-13 22:32:35 / Modified: 22:40:09" itemprop="dateCreated datePublished" datetime="2024-06-13T22:32:35+08:00">2024-06-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="How-to-Implement-Custom-GORM-Logger"><a href="#How-to-Implement-Custom-GORM-Logger" class="headerlink" title="How to Implement Custom GORM Logger"></a>How to Implement Custom GORM Logger</h1><p>GORM is a powerful ORM library for Go, widely used for database interactions. While GORM provides default logging capabilities, there are scenarios where you might need more customized logging solutions to suit your application’s requirements.</p>
<ol>
<li><p>Implement the interface</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</span><br><span class="line">  LogMode(LogLevel) Interface</span><br><span class="line">  Info(context.Context, <span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">  Warn(context.Context, <span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">  Error(context.Context, <span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">  Trace(ctx context.Context, begin time.Time, fc <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(sql <span class="keyword">string</span>, rowsAffected <span class="keyword">int64</span>)</span>, <span class="title">err</span> <span class="title">error</span>)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> implementation</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> orm</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;strings&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">  log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">  <span class="string">&quot;gorm.io/gorm/logger&quot;</span></span><br><span class="line">  gorm_util <span class="string">&quot;gorm.io/gorm/utils&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserUIDKey = <span class="string">&quot;user_uid&quot;</span></span><br><span class="line"><span class="keyword">const</span> slowThreshold = <span class="number">200</span> * time.Millisecond</span><br><span class="line"></span><br><span class="line"><span class="comment">// CustomGormLogger defines custom gorm logger</span></span><br><span class="line"><span class="keyword">type</span> CustomGormLogger <span class="keyword">struct</span> &#123; </span><br><span class="line">  logger logger.Interface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewCustomGormLogger new a gorm custom logger instance</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCustomGormLogger</span><span class="params">()</span> *<span class="title">CustomGormLogger</span></span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> &amp;CustomGormLogger&#123;  </span><br><span class="line">    logger: logger.Default,</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LogMode log mode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomGormLogger)</span> <span class="title">LogMode</span><span class="params">(lev logger.LogLevel)</span> <span class="title">logger</span>.<span class="title">Interface</span></span> &#123;  </span><br><span class="line">  <span class="keyword">return</span> l.logger.LogMode(lev)</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// Info print info</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomGormLogger)</span> <span class="title">Info</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;  </span><br><span class="line">  l.logger.Info(ctx, msg, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Warn print warn messages</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomGormLogger)</span> <span class="title">Warn</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;  </span><br><span class="line">  l.logger.Warn(ctx, msg, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Error print error messages</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomGormLogger)</span> <span class="title">Error</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, data ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;  </span><br><span class="line">  l.logger.Error(ctx, msg, data) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trace print custom sql message with uid</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *CustomGormLogger)</span> <span class="title">Trace</span><span class="params">(ctx context.Context, begin time.Time, fc <span class="keyword">func</span>()</span> <span class="params">(sql <span class="keyword">string</span>, rowsAffected <span class="keyword">int64</span>)</span>, <span class="title">err</span> <span class="title">error</span>)</span> &#123;</span><br><span class="line">  userUid := ctx.Value(UserUIDKey)</span><br><span class="line">  elapsed := <span class="keyword">float64</span>(time.Since(begin))/<span class="number">1e6</span></span><br><span class="line"></span><br><span class="line">  sql, rows := fc()</span><br><span class="line">  formatSql := strings.ReplaceAll(sql, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  log.Infof(<span class="string">&quot;[file]=%s&quot;</span>, gorm_util.FileWithLineNum())</span><br><span class="line">  log.Infof(<span class="string">&quot;[%.3fms][rows %d][user_uid %s] %s&quot;</span>, elapsed, rows, userUid, formatSql)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">    log.Warnf(<span class="string">&quot;[%.3fms] SQL ERROR, %v&quot;</span>, elapsed, err)</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">if</span> elapsed &gt; <span class="keyword">float64</span>(slowThreshold.Nanoseconds()) &#123;  </span><br><span class="line">    log.Infof(<span class="string">&quot;[%.3fms] SLOW SQL&quot;</span>, elapsed)  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enable debug mode and replace with custom logger</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewServer creates a server implementation for student server.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServer</span><span class="params">(ctx context.Context, config Config)</span> <span class="params">(studentplanpb.StudentPlanServiceServer, error)</span></span> &#123;</span><br><span class="line">  connectionString := fmt.Sprintf(db.CONNECTION_FORMAT_STRING, config.SQLHost, config.DBUser, config.DBPassword, config.DBPort, config.SQLDB)</span><br><span class="line">  db, err := db.InitDB(connectionString)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to connect to mysqlDB: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> config.DBDebug &#123;</span><br><span class="line">    db = db.Debug()</span><br><span class="line">    defaultLogger := orm.CustomGormLogger()</span><br><span class="line">    defaultLogger.LogMode(logger.Info)</span><br><span class="line">    db.Logger = defaultLogger</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  s := &amp;impl&#123;</span><br><span class="line">    Config:     config,</span><br><span class="line">    db:         db,</span><br><span class="line">    pool:       pool,</span><br><span class="line">    stroageCli: stroageCli,</span><br><span class="line">    stdriver:   stroageServer,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Usage<br> It is more better to implement ParseAuthorization as middleware and set UserUIDKey for custom GORM logging within the middleware to avoid code duplication.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *impl)</span> <span class="title">queryUserss</span><span class="params">(ctx context.Context, req *userpb.QueryUsersRequest)</span> <span class="params">(*userpb.QueryUsersResponse, error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// check user role</span></span><br><span class="line">  uid, role := jwtext.ParseAuthorization(ctx, s.JWT)</span><br><span class="line">  <span class="keyword">if</span> role == userpb.Role_UNKNOWN &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.GrpcError(codes.Unauthenticated, <span class="string">&quot;user not logged in&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set UserUIDKey for custom gorm logging</span></span><br><span class="line">  ctx = context.WithValue(ctx, orm.UserUIDKey, uid)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Result</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time=<span class="string">&quot;2024-05-16T14:11:23+08:00&quot;</span> level=info msg=<span class="string">&quot;starting student server at port :9090&quot;</span></span><br><span class="line">time=<span class="string">&quot;2024-05-16T14:11:25+08:00&quot;</span> level=info msg=<span class="string">&quot;[file]=xxx/backend/v3/pkg/db/utils.go:264&quot;</span></span><br><span class="line">time=<span class="string">&quot;2024-05-16T14:11:25+08:00&quot;</span> level=info msg=<span class="string">&quot;[16.995ms][rows 1][user_uid 435e7fa8-b444-11ee-96d1-3e9675b204c9] SELECT * FROM users WHERE id=&#x27;435e7fa8-b444-11ee-96d1-3e9675b204c9&#x27; and deleted=0 ORDER BY users.id OFFSET 0 ROW FETCH NEXT 1 ROWS ONLY&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/12/Practical-Experiences-with-Modern-Databases/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/12/Practical-Experiences-with-Modern-Databases/" class="post-title-link" itemprop="url">Practical Experiences with Modern Databases</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-12 22:57:40" itemprop="dateCreated datePublished" datetime="2024-06-12T22:57:40+08:00">2024-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-07-08 22:44:51" itemprop="dateModified" datetime="2024-07-08T22:44:51+08:00">2024-07-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Practical-Experiences-with-Modern-Databases"><a href="#Practical-Experiences-with-Modern-Databases" class="headerlink" title="Practical Experiences with Modern Databases"></a>Practical Experiences with Modern Databases</h1><h2 id="DeadLock-in-Transaction"><a href="#DeadLock-in-Transaction" class="headerlink" title="DeadLock in Transaction"></a>DeadLock in Transaction</h2><p>Prevention:</p>
<ol>
<li><p><strong>Order Resource Acquisition Consistently:</strong><br>Ensure that resources are acquired in a consistent order across transactions to avoid circular wait conditions.</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transaction 1 (T1):</span><br><span class="line">update(Resource A)</span><br><span class="line">update(Resource B)</span><br><span class="line"></span><br><span class="line">Transaction 2 (T2):</span><br><span class="line">update(Resource A)</span><br><span class="line">update(Resource B)</span><br></pre></td></tr></table></figure>
<p> In this example, both T1 and T2 acquire Resource A first, ensuring there is no circular wait condition:</p>
<ul>
<li><p>T1 acquires Resource A and waits for Resource B.</p>
</li>
<li><p>T2 acquires Resource B and waits for Resource A.</p>
<p>Execute table or row operations in a consistent order within transactions to avoid deadlocks between different transactions.</p>
<p>For more information on PostgreSQL lock monitoring and handling lock waits, refer to:</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://pganalyze.com/blog/5mins-postgres-lock-monitoring-lwlock-log-lock-waits">5mins of Postgres E25: Postgres lock monitoring, LWLocks and the log_lock_waits setting</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35319597/how-to-stop-kill-a-query-in-postgresql">How to stop/kill a query in postgresql?</a></p>
</li>
</ul>
</li>
<li><p><strong>Implement a Timeout Mechanism:</strong><br>Use a timeout mechanism to abort transactions that have been waiting too long, preventing long waits and potential deadlocks. For example, set <code>context.WithTimeout</code> in Golang for the root context.</p>
</li>
<li><p><strong>Move Query Operations Outside of Transactions if Possible:</strong><br>Whenever possible, perform query operations outside of transactions to reduce the risk of deadlocks. Additionally, shorten the duration of transactions.</p>
</li>
<li><p><strong>Avoid Long Transaction</strong></p>
</li>
</ol>
<h2 id="Time-and-Timezone-In-Database"><a href="#Time-and-Timezone-In-Database" class="headerlink" title="Time and Timezone In Database"></a>Time and Timezone In Database</h2><p><strong>Timestamp Format</strong></p>
<ul>
<li>Store Timestamps in UTC:<br>  It ensures consistency and avoids complications arising from daylight saving time changes and other timezone-related issues.</li>
<li>Set the Database Timezone to UTC:<br>  If your database system allows setting the timezone, setting it to UTC can enforce consistency and avoid unexpected behavior in date and time functions.</li>
<li>Handle Timezones at the Application Level:<br>  Manage timezone conversions within your application. Store timestamps in UTC in the database and convert to the appropriate local time zone when needed for display or user interactions</li>
</ul>
<p><strong>Epoch Format</strong></p>
<ul>
<li>Epoch time, representing the number of seconds (or milliseconds) since a fixed point (1970-01-01 00:00:00 UTC), can be more efficient for storage and quicker for comparison operations. However, since epoch time does not inherently include time zone information or formatting, it should only be used if your application is completely time zone independent.<h2 id="Default-Connection-Limit"><a href="#Default-Connection-Limit" class="headerlink" title="Default Connection Limit"></a>Default Connection Limit</h2></li>
</ul>
<p>For microservices, it is crucial to be aware that each service has a default connection limit for both the database server and the client. As the number of services increases, you may encounter bottlenecks because all available connections can become occupied.</p>
<p>Use PostgreSQL as an example</p>
<ul>
<li><p><strong>Client Side:</strong><br>If you are using an ORM package, it may provide relevant settings for the client service.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ex: gorm:</span><br><span class="line">  sqlDB.SetMaxIdleConns(defaultMaxIdleConn)</span><br><span class="line">  sqlDB.SetMaxOpenConns(defaultMaxOpenConn)</span><br><span class="line">  sqlDB.SetConnMaxLifetime(defaultLifetime)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Server Side:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30778015/how-to-increase-the-max-connections-in-postgres">How to increase the max connections in postgres?</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/runtime-config-connection.html#RUNTIME-CONFIG-CONNECTION">20.3. Connections and Authentication</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">max_connections (integer) </span><br><span class="line">Determines the maximum number of concurrent connections to the database server. The default is typically 100 connections.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Using-Shorter-Keys-in-Indexes"><a href="#Using-Shorter-Keys-in-Indexes" class="headerlink" title="Using Shorter Keys in Indexes"></a>Using Shorter Keys in Indexes</h2><p>Using shorter keys in B-Tree indexes offers multiple benefits, including improved performance, efficient memory and storage usage, and better cache utilization.</p>
<p>  <strong>MySQL B+ Tree Indexes:</strong><br>  MySQL uses B+ Tree indexes, which are a variation of B-Tree indexes with additional optimizations. These indexes ensure that all values are stored at the leaf level and linked in a doubly linked list, enhancing range query performance and efficiency.</p>
<p>  <strong>PostgreSQL B-Tree Indexes:</strong><br>  PostgreSQL utilizes B-Tree indexes to efficiently manage and query large datasets. The structure and operation of these indexes can be explored in detail in the PostgreSQL documentation:<br>  <a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/btree-implementation.html#:~:text=PostgreSQL%20B%2DTree%20indexes%20are,leaf%20pages%20or%20internal%20pages">PostgreSQL B-Tree Implementation doc</a></p>
<h2 id="Materialized-Views-Views-for-Frequently-Used-Join-Queries"><a href="#Materialized-Views-Views-for-Frequently-Used-Join-Queries" class="headerlink" title="Materialized-Views/Views for Frequently Used Join Queries."></a>Materialized-Views/Views for Frequently Used Join Queries.</h2><p>Views</p>
<ul>
<li>By encapsulating frequently used queries, views ensure consistent results and reduce the need for query repetition. They can be reused across different parts of the application.<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2454113/why-is-database-view-used"><strong>Why is database view used?</strong></a></li>
<li>Notice: Views do not store data themselves; instead, they dynamically retrieve data from the underlying tables each time they are accessed.</li>
</ul>
<p>Materialized views</p>
<ul>
<li>A materialized view is a database object that contains the results of a query. Unlike a regular view, the result of the query is stored in the database, occupying physical space. This can improve query performance by providing quick access to precomputed and joined results.</li>
<li>Notice: Since materialized views store data physically, they are not suitable for real-time data, frequent data changes, or when storage is a concern.</li>
</ul>
<h2 id="Database-Parameter-Limits"><a href="#Database-Parameter-Limits" class="headerlink" title="Database Parameter Limits"></a>Database Parameter Limits</h2><p>When dealing with large datasets, there’s a risk of hitting database parameter limits, which can cause performance bottlenecks. By dividing large operations into smaller chunks, systems can avoid hitting these limits while maintaining performance and scalability.</p>
<ul>
<li><p><strong>PostgreSQL</strong><br><a target="_blank" rel="noopener" href="https://klotzandrew.com/blog/postgres-passing-65535-parameter-limit">Passing the Postgres 65535 parameter limit at 120x speed</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gorm provide CreateInBatches function to dividing large operations into smaller chunks</span></span><br><span class="line"><span class="comment">// CreateInBatches insert the value in batches of batchSize</span></span><br><span class="line">CreateInBatches(value <span class="keyword">interface</span>&#123;&#125;, batchSize <span class="keyword">int</span>) DB</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MSSQL</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define mssql parameter limit, not to exceed query limit 2100</span></span><br><span class="line">MSSQL_PARAMETER_LIMIT = <span class="number">2048</span></span><br><span class="line"><span class="comment">// ChunkSlice chunk slice into chunks with size</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ChunkSlice</span><span class="params">(slice []<span class="keyword">int64</span>, chunkSize <span class="keyword">int</span>)</span> [][]<span class="title">int64</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> chunks [][]<span class="keyword">int64</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(slice); i += chunkSize &#123;</span><br><span class="line">    end := i + chunkSize</span><br><span class="line">    <span class="comment">// necessary check to avoid slicing beyond</span></span><br><span class="line">    <span class="comment">// slice capacity</span></span><br><span class="line">    <span class="keyword">if</span> end &gt; <span class="built_in">len</span>(slice) &#123;</span><br><span class="line">      end = <span class="built_in">len</span>(slice)</span><br><span class="line">    &#125;</span><br><span class="line">    chunks = <span class="built_in">append</span>(chunks, slice[i:end])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> chunks</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">chunks := common.ChunkSlice(req.GetIds(), common.MSSQL_PARAMETER_LIMIT)</span><br><span class="line"><span class="keyword">for</span> _, chunk := <span class="keyword">range</span> chunks &#123;</span><br><span class="line">  <span class="comment">// query restored student plan IDs are all in same school plan</span></span><br><span class="line">  <span class="keyword">var</span> users []*db.Users</span><br><span class="line">  <span class="keyword">if</span> err := s.db.WithContext(ctx).Model(&amp;db.Users&#123;&#125;).Where(<span class="string">&quot;id IN (?) AND deleted=0&quot;</span>, chunk).Scan(&amp;users).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;failed to query users by ids, err: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... fellowing operation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Composite-Indexes-to-Avoid-Bookmark-Lookup"><a href="#Composite-Indexes-to-Avoid-Bookmark-Lookup" class="headerlink" title="Composite Indexes to Avoid Bookmark Lookup"></a>Composite Indexes to Avoid Bookmark Lookup</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sql/relational-databases/indexes/clustered-and-nonclustered-indexes-described?view=sql-server-ver16">Clustered and nonclustered indexes</a></p>
<p>When a non-clustered index is used to locate rows, the database engine first searches the non-clustered index to find the indexed columns. If the query needs columns not included in the index, the engine then performs a bookmark lookup to retrieve the rest of the row’s data from the clustered index.</p>
<p>A composite index includes multiple columns from the table. If a query’s SELECT clause or WHERE clause references all the columns in the composite index, the database engine can satisfy the query using just the index without needing to perform a bookmark lookup.</p>
<p>ex:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> composite_index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column1, column2);</span><br></pre></td></tr></table></figure>

<h2 id="Using-Indexes-to-Optimize-Fuzzy-Search-Queries"><a href="#Using-Indexes-to-Optimize-Fuzzy-Search-Queries" class="headerlink" title="Using Indexes to Optimize Fuzzy Search Queries"></a>Using Indexes to Optimize Fuzzy Search Queries</h2><p>Fuzzy search refers to queries that are used to find records that match a pattern, typically using the LIKE operator in SQL. Using indexes to optimize fuzzy search queries can be a bit challenging, especially if the pattern starts with a wildcard (e.g., %pattern). However, there are strategies to make it more efficient:</p>
<ul>
<li>Trigrams:<br>Trigrams are a way to break down a text into substrings of three characters. By indexing these trigrams, you can perform more efficient fuzzy searches.<br><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/pgtrgm.html">pg_trgm — support for similarity of text using trigram matching</a><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> EXTENSION pg_trgm;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> trgm_idx_users_username <span class="keyword">ON</span> <span class="keyword">users</span> <span class="keyword">USING</span> gin (username gin_trgm_ops);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Avoid-Generating-Temporary-Tables-for-Small-Joins"><a href="#Avoid-Generating-Temporary-Tables-for-Small-Joins" class="headerlink" title="Avoid Generating Temporary Tables for Small Joins"></a>Avoid Generating Temporary Tables for Small Joins</h2><p>When performing a join between tables that are not large, it is generally advisable to avoid generating temporary tables by selecting columns in the join condition.</p>
<p>  <strong>PostgreSQL</strong><br>  <a target="_blank" rel="noopener" href="https://www.crunchydata.com/blog/get-started-with-explain-analyze">Explaining Your Postgres Query Performance</a></p>
<p>  <strong>MSSQL</strong></p>
<ul>
<li><p><strong>generate temporary tables</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SHOWPLAN_XML <span class="keyword">ON</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Your query here</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    users.*, </span><br><span class="line">    a.auth_id, </span><br><span class="line">    a.auth_deleted, </span><br><span class="line">    a.auth_create_user, </span><br><span class="line">    a.auth_create_time, </span><br><span class="line">    a.auth_belong_to</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="keyword">users</span></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">        a.id <span class="keyword">AS</span> auth_id,</span><br><span class="line">        a.plan_id <span class="keyword">AS</span> auth_plan_id,</span><br><span class="line">        a.user_id <span class="keyword">AS</span> auth_user_id,</span><br><span class="line">        a.role <span class="keyword">AS</span> auth_role,</span><br><span class="line">        a.belong_to <span class="keyword">AS</span> auth_belong_to,</span><br><span class="line">        a.deleted <span class="keyword">AS</span> auth_deleted,</span><br><span class="line">        a.create_user <span class="keyword">AS</span> auth_create_user,</span><br><span class="line">        a.create_time <span class="keyword">AS</span> auth_create_time</span><br><span class="line">    <span class="keyword">FROM</span> </span><br><span class="line">        auths a</span><br><span class="line">    <span class="keyword">WHERE</span> </span><br><span class="line">        a.plan_id = <span class="number">3</span> </span><br><span class="line">        <span class="keyword">AND</span> a.role = <span class="number">6</span> </span><br><span class="line">        <span class="keyword">AND</span> a.deleted = <span class="number">0</span> </span><br><span class="line">        <span class="keyword">AND</span> a.belong_to = <span class="number">3794</span></span><br><span class="line">) <span class="keyword">AS</span> a </span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    a.auth_user_id = users.id</span><br><span class="line"><span class="keyword">WHERE</span>  </span><br><span class="line">    users.role = <span class="number">6</span> </span><br><span class="line">    <span class="keyword">AND</span> users.school_code = <span class="string">&#x27;014666&#x27;</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> SHOWPLAN_XML <span class="keyword">OFF</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="/2024/06/12/Practical-Experiences-with-Modern-Databases/join_table_1.png" width="100%" height="100%" title="join_table_1" alt="join_table_1">
</li>
<li><p><strong>no temporary tables are generated</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SHOWPLAN_XML <span class="keyword">ON</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Your query here</span></span><br><span class="line"><span class="keyword">select</span> u.id, u.name, u.email, a.*</span><br><span class="line">        <span class="keyword">from</span> <span class="keyword">users</span> u</span><br><span class="line">        <span class="keyword">left</span> <span class="keyword">join</span> auths a <span class="keyword">ON</span> a.user_id=u.id <span class="keyword">and</span> a.plan_id=<span class="number">3</span> <span class="keyword">and</span> a.role=u.role <span class="keyword">and</span> a.deleted=<span class="number">0</span> <span class="keyword">and</span> a.belong_to=<span class="number">3794</span></span><br><span class="line">        <span class="keyword">where</span> u.role=<span class="number">6</span> <span class="keyword">and</span> u.school_code=<span class="string">&#x27;014666&#x27;</span>;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> SHOWPLAN_XML <span class="keyword">OFF</span>;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>
<img src="/2024/06/12/Practical-Experiences-with-Modern-Databases/join_table_2.png" width="100%" height="100%" title="join_table_2" alt="join_table_2">
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/25/Debouncing-mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/25/Debouncing-mechanism/" class="post-title-link" itemprop="url">Debouncing Mechanism With Golang</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-25 12:38:26" itemprop="dateCreated datePublished" datetime="2023-12-25T12:38:26+08:00">2023-12-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-24 00:01:06" itemprop="dateModified" datetime="2024-08-24T00:01:06+08:00">2024-08-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Debounce/" itemprop="url" rel="index"><span itemprop="name">Debounce</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Debouncing mechanism can be useful in scenarios where you want to handle events that may be triggered frequently but should only be processed once within a certain time window.</p>
<ul>
<li>Button Clicks</li>
<li>Event Handling</li>
<li>Throttling</li>
</ul>
<h2 id="Debouncing-to-ensure-that-only-the-final-input-registers-or-prevails"><a href="#Debouncing-to-ensure-that-only-the-final-input-registers-or-prevails" class="headerlink" title="Debouncing to ensure that only the final input registers or prevails"></a>Debouncing to ensure that only the final input registers or prevails</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--|--|--|--|--|--|--|--|-------------------|--|--|--|--|</span><br><span class="line">                       trigger                         trigger</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/bep/debounce/blob/master/debounce.go">reference code</a><br>This code snippet provides a simpler and more lightweight debouncing mechanism. The debouncer function takes a callback function and ensures that it is called only after a specified time duration has passed since the last invocation.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> debounceDelay = <span class="number">1</span> * time.Second</span><br><span class="line"><span class="keyword">const</span> eventTriggerInterval = <span class="number">500</span> * time.Millisecond</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a debouncer with a 500ms delay</span></span><br><span class="line">	debounce := New(debounceDelay)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a channel to receive events</span></span><br><span class="line">	eventChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Goroutine to listen to the channel and debounce events</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="comment">// Wait for an event to be received on the channel</span></span><br><span class="line">			&lt;-eventChannel</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Trigger the debouncer with the function you want to execute</span></span><br><span class="line">			debounce(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="comment">// Your code to be executed after the debounce delay</span></span><br><span class="line">				<span class="built_in">println</span>(<span class="string">&quot;Event debounced&quot;</span>)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Simulate events by sending to the channel</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;event %d at time %v\n&quot;</span>, i, time.Now())</span><br><span class="line">		<span class="comment">// Simulate an event by sending to the channel</span></span><br><span class="line">		eventChannel &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Sleep for a short duration to simulate time passing between events</span></span><br><span class="line">		time.Sleep(eventTriggerInterval)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for some time to allow debouncer to process the last event</span></span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// The debounced function can be invoked with different functions, if needed,</span></span><br><span class="line"><span class="comment">// the last one will win.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(after time.Duration)</span> <span class="title">func</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	d := &amp;debouncer&#123;after: after&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">		d.add(f)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> debouncer <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu    sync.Mutex</span><br><span class="line">	after time.Duration</span><br><span class="line">	timer *time.Timer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *debouncer)</span> <span class="title">add</span><span class="params">(f <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	d.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> d.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> d.timer != <span class="literal">nil</span> &#123;</span><br><span class="line">		d.timer.Stop()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a new timer and start it</span></span><br><span class="line">	d.timer = time.AfterFunc(d.after, f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Debouncing-for-fine-grained-control-over-frequent-events-achieving-precise-timing-control"><a href="#Debouncing-for-fine-grained-control-over-frequent-events-achieving-precise-timing-control" class="headerlink" title="Debouncing for fine-grained control over frequent events, achieving precise timing control"></a>Debouncing for fine-grained control over frequent events, achieving precise timing control</h2><p>This code provides a more comprehensive implementation to handle frequent events with precise timing control. The triggers are collected in a channel, and the debouncing logic ensures that only the last trigger within a specified interval is processed.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-----|-----|-----|-----|-----|-----|-----|-----|-----=-----------|----- ----- -----=-----</span><br><span class="line">              trigger           trigger           trigger                      trigger</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> debounceInterval time.Duration = <span class="number">3</span> * time.Second</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set the time interval for the ticker</span></span><br><span class="line">	interval := <span class="number">1</span> * time.Second</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the total duration to listen to the ticker</span></span><br><span class="line">	totalDuration := <span class="number">10</span> * time.Second</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a ticker that ticks at the specified interval</span></span><br><span class="line">	ticker := time.NewTicker(interval)</span><br><span class="line">	<span class="keyword">defer</span> ticker.Stop()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a channel to signal the end of the program after the specified duration</span></span><br><span class="line">	done := time.After(totalDuration)</span><br><span class="line"></span><br><span class="line">	manager := &amp;ResourceManager&#123;</span><br><span class="line">		TriggerTimes: <span class="built_in">make</span>(<span class="keyword">chan</span> time.Time, <span class="number">100</span>),</span><br><span class="line">		Done:         <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">		manager.DebounceTrigger()</span><br><span class="line"></span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start a loop to listen to ticker events</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">			<span class="comment">// Do something on each tick</span></span><br><span class="line">			fmt.Println(<span class="string">&quot;Tick&quot;</span>)</span><br><span class="line">			manager.TriggerTimes &lt;- time.Now()</span><br><span class="line">		<span class="keyword">case</span> &lt;-done:</span><br><span class="line">			<span class="comment">// Break out of the loop after the specified duration</span></span><br><span class="line">			fmt.Println(<span class="string">&quot;Time&#x27;s up!&quot;</span>)</span><br><span class="line">			manager.Done &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">			numGoroutines := runtime.NumGoroutine()</span><br><span class="line">			fmt.Println(numGoroutines)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ResourceManager <span class="keyword">struct</span> &#123;</span><br><span class="line">	mutex sync.Mutex</span><br><span class="line">	<span class="comment">// TriggerTimes define a channel that collects the receiving time of each message from the callback channel.</span></span><br><span class="line">	TriggerTimes <span class="keyword">chan</span> time.Time</span><br><span class="line">	Done         <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ResourceManager)</span> <span class="title">DebounceTrigger</span><span class="params">()</span></span> &#123;</span><br><span class="line">	expectedTime := time.Now()</span><br><span class="line">	ignoredAtomic := atomic.Bool&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> t := <span class="keyword">range</span> m.TriggerTimes &#123;</span><br><span class="line">		<span class="keyword">if</span> t.After(expectedTime) &#123;</span><br><span class="line">			expectedTime = time.Now().Add(debounceInterval)</span><br><span class="line">			fmt.Println(<span class="string">&quot;update expectedTime&quot;</span>)</span><br><span class="line">			<span class="comment">// insert a new event to m.TriggerTimes after debounceInterval.</span></span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="comment">// since AfterFunc is blocking, need to run in another thread.</span></span><br><span class="line">				time.AfterFunc(debounceInterval, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					<span class="comment">// load the ignored boolean and reset it.</span></span><br><span class="line">					<span class="keyword">if</span> ignored := ignoredAtomic.Swap(<span class="literal">false</span>); ignored &#123;</span><br><span class="line">						fmt.Printf(<span class="string">&quot;do process with time %v \n&quot;</span>, t)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;()</span><br><span class="line"></span><br><span class="line">			fmt.Printf(<span class="string">&quot;do process with time %v \n&quot;</span>, t)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ignoredAtomic.Store(<span class="literal">true</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/20/Golang-CSP-Channel-And-Gorutine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/20/Golang-CSP-Channel-And-Gorutine/" class="post-title-link" itemprop="url">Golang CSP: Channel And Gorutine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-20 23:56:24" itemprop="dateCreated datePublished" datetime="2023-12-20T23:56:24+08:00">2023-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 00:07:06" itemprop="dateModified" datetime="2023-12-21T00:07:06+08:00">2023-12-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Golang-CSP-Channel-And-Gorutine"><a href="#Golang-CSP-Channel-And-Gorutine" class="headerlink" title="Golang CSP: Channel And Gorutine"></a>Golang CSP: Channel And Gorutine</h1><p>In Go (Golang), channels and goroutines are key components of the language’s concurrency model, which is inspired by Communicating Sequential Processes (CSP). CSP is a formal language for describing patterns of interaction in concurrent systems. The main ideas of CSP include processes communicating by sending and receiving messages over channels, and synchronization through communication rather than through shared memory.<br>Channels in Go are a communication mechanism designed to allow one goroutine to safely send data to another goroutine in concurrent or multi-goroutine scenarios.</p>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
</blockquote>
<h2 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h2><p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/runtime/chan.go">chan.go</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">	qcount   <span class="keyword">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">	dataqsiz <span class="keyword">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">	buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">	elemsize <span class="keyword">uint16</span></span><br><span class="line">	closed   <span class="keyword">uint32</span></span><br><span class="line">	elemtype *_type <span class="comment">// element type</span></span><br><span class="line">	sendx    <span class="keyword">uint</span>   <span class="comment">// send index</span></span><br><span class="line">	recvx    <span class="keyword">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">	recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">	sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line">	lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2023/12/20/Golang-CSP-Channel-And-Gorutine/channel_structure.jpg" width="100%" height="100%" title="image" alt="channel_structure">


<h3 id="UnBuffered-Channels"><a href="#UnBuffered-Channels" class="headerlink" title="UnBuffered Channels"></a>UnBuffered Channels</h3><p>By default channels are unbuffered, meaning that they will only accept sends (chan &lt;-) if there is a corresponding receive (&lt;- chan) ready to receive the sent value. It enforces a synchronous communication between the two goroutines involved in the communication</p>
<ol>
<li>The producers and consumers of a channel appear in pairs, but both within the same goroutine. <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  c &lt;- <span class="string">&quot;hello&quot;</span> <span class="comment">// block for ever</span></span><br><span class="line">  msg := &lt;-c</span><br><span class="line">  fmt.Println(msg)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line"><span class="comment">goroutine 1 [chan send]:</span></span><br><span class="line"><span class="comment">main.main()</span></span><br><span class="line"><span class="comment">  /tmp/sandbox3222265902/prog.go:9 +0x36</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li><p>The producers and consumers of a channel operate in pairs but within different goroutines.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ms := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;hello&quot;</span></span><br><span class="line">  &#125;(ms)</span><br><span class="line">  msg := &lt;-ms</span><br><span class="line">  fmt.Println(msg)  <span class="comment">// hello</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unbuffered channels are useful in scenarios where synchronization between two goroutines since it ensure that the sender and receiver are ready to communicate at the same time.</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  dog  = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  cat  = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  fish = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">  wg   sync.WaitGroup</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Dog</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-dog</span><br><span class="line">  fmt.Println(<span class="string">&quot;dog&quot;</span>)</span><br><span class="line">  cat &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cat</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-cat</span><br><span class="line">  fmt.Println(<span class="string">&quot;cat&quot;</span>)</span><br><span class="line">  fish &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fish</span><span class="params">()</span></span> &#123;</span><br><span class="line">  &lt;-fish</span><br><span class="line">  fmt.Println(<span class="string">&quot;fish&quot;</span>)</span><br><span class="line">  dog &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    wg.Add(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Dog()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Cat()</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      Fish()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start the cycle</span></span><br><span class="line">  dog &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A fatal error occurred at the end of the process due to the absence of any receiver for the last message sent on the unbuffered channel &#x27;fish&#x27;.</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">dog</span></span><br><span class="line"><span class="comment">cat</span></span><br><span class="line"><span class="comment">fish</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">dog</span></span><br><span class="line"><span class="comment">cat</span></span><br><span class="line"><span class="comment">fish</span></span><br><span class="line"><span class="comment">fatal error: all goroutines are asleep - deadlock!</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="4">
<li>In some scenarios like timeout control, may lead to memory leak.<ul>
<li>If there is no timeout, <code>doLongTask</code> signals the unbuffered channel <code>done</code>, and the <code>select</code> statement receives the signal. Consequently, <code>doLongTask</code> and the child coroutine can exit gracefully.</li>
<li>When a timeout occurs, the <code>select</code> statement receives the timeout signal from <code>time.After</code> and returns. Since unbuffered channel <code>done</code> has no receiver at this point, and <code>doLongTask</code> sends a signal to channel <code>done</code> after 1 second of execution, the sender will be blocked indefinitely due to the lack of a receiver and no buffer, preventing the coroutine from exiting.<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doLongTask</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  time.Sleep(time.Second) <span class="comment">// long task</span></span><br><span class="line">  done &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeout</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">  done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>) <span class="comment">// unbuffered channel</span></span><br><span class="line">  <span class="keyword">go</span> f(done)</span><br><span class="line">  <span class="comment">// If there is no default statement in the select statement, it will block and wait for any of the case statements.</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-done:</span><br><span class="line">    fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond):</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDoLongTask</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    timeout(doLongTask)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">  t.Log(runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">=== RUN   TestDoLongTask</span></span><br><span class="line"><span class="comment">    prog_test.go:38: 1002</span></span><br><span class="line"><span class="comment">--- PASS: TestDoLongTask (3.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ol>
<h3 id="Buffered-Channels"><a href="#Buffered-Channels" class="headerlink" title="Buffered Channels"></a>Buffered Channels</h3><p>Golang provides buffered channels, which allow you to specify a fixed length of buffer capacity so one can send that number of data values at once. These channels are only blocked when the buffer is full.</p>
<ol>
<li>To prevent memory leaks, utilize buffered channels to avoid the sender from being blocked, even in the absence of a receiver. <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doLongTask</span><span class="params">(done <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  time.Sleep(time.Second) <span class="comment">// long task</span></span><br><span class="line">  done &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeout</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">  done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>) <span class="comment">// buffered channel</span></span><br><span class="line">  <span class="keyword">go</span> f(done)</span><br><span class="line">  <span class="comment">// If there is no default statement in the select statement, it will block and wait for any of the case statements.</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-done:</span><br><span class="line">    fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(time.Millisecond):</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDoLongTask</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    timeout(doLongTask)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">  t.Log(runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">=== RUN   TestBufferTimeout</span></span><br><span class="line"><span class="comment">    prog_test.go:34: 2</span></span><br><span class="line"><span class="comment">--- PASS: TestBufferTimeout (3.00s)</span></span><br><span class="line"><span class="comment">PASS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="Select-Statement"><a href="#Select-Statement" class="headerlink" title="Select Statement"></a>Select Statement</h3><p><code>select</code> statement is used to deal with multiple communication operations. It allows a goroutine to wait on multiple communication operations and proceed as soon as one of them can proceed. This is particularly useful when working with channels to handle concurrent communication and synchronization.<br>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  taskCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage started...&quot;</span>)</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage ending...&quot;</span>)</span><br><span class="line">    <span class="built_in">close</span>(taskCh)</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait for the first segment of a task to complete or timeout using the select statement</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-taskCh:</span><br><span class="line">    fmt.Println(<span class="string">&quot;First stage completed. Continuing with the next stages...&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;Timeout occurred. Aborting further stages.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">&quot;Second stage started...&quot;</span>)</span><br><span class="line">  time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">  fmt.Println(<span class="string">&quot;Second stage ending...&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/runtime/select.go#L121">selectgo</a></p>
<ol>
<li>The select statement in Go is a specialized statement used exclusively for sending and receiving messages on channels. This statement is blocking during execution. When there is no case statement in the select, it will block the current goroutine.</li>
<li>select is Go’s language-level mechanism for I/O multiplexing. It is specifically designed to detect whether multiple channels are ready: either for reading or writing.</li>
<li>In the select statement, except for default, each case operates on a single channel, either for reading or writing.</li>
<li>In the select statement, except for default, the execution order of each case is random.</li>
<li>If there is no default statement in the select statement, it will block and wait for any of the case statements.</li>
<li>In the select statement, when performing a read operation, it is necessary to check whether the read was successful. Closed channels can also be read in the select statement.</li>
</ol>
<h3 id="Channel-Operations"><a href="#Channel-Operations" class="headerlink" title="Channel Operations"></a>Channel Operations</h3><h4 id="1-Sending-Data-chan-lt"><a href="#1-Sending-Data-chan-lt" class="headerlink" title="1. Sending Data (chan &lt;-)"></a>1. Sending Data (chan &lt;-)</h4><ul>
<li>If the receiving queue (recvq) is not empty, it signifies an absence of data in the buffer or the absence of a buffer. In such a scenario, retrieve a Goroutine (G) from recvq, write the data, awaken G, and conclude the sending process.</li>
<li>If there is space available in the buffer, write the data into the buffer, concluding the sending process.</li>
<li>If the buffer has no available space, write the data to be sent into G, add the current G to the sending queue (sendq), enter a sleep state, and await awakening by a reading</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Send to a closed channel cause panic **</span></span><br><span class="line">  <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Dequeuing from Receiver Queue **</span></span><br><span class="line">  <span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// Found a waiting receiver. We pass the value we want to send</span></span><br><span class="line">    <span class="comment">// directly to the receiver, bypassing the channel buffer (if any).</span></span><br><span class="line">    send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Enqueuing to Channel Buffer **</span></span><br><span class="line">  <span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">    <span class="comment">// Space is available in the channel buffer. Enqueue the element to send.</span></span><br><span class="line">    qp := chanbuf(c, c.sendx)</span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">      racenotify(c, c.sendx, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">    c.sendx++</span><br><span class="line">    <span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">      c.sendx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.qcount++</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Block on the channel if is allowed, it then enqueues the current goroutine(mysg) to the send queue (c.sendq) and parks the goroutine (gopark). This means the goroutine will be put to sleep until a receiver completes the operation. **</span></span><br><span class="line">  gp := getg()</span><br><span class="line">  mysg := acquireSudog()</span><br><span class="line">  mysg.releasetime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  gp.waiting = mysg</span><br><span class="line">  gp.param = <span class="literal">nil</span></span><br><span class="line">  c.sendq.enqueue(mysg)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ** Ensure the value being sent is kept alive until the receiver copies it out. **</span></span><br><span class="line">  KeepAlive(ep)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// someone woke us up.</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-Receiving-Data-lt-chan"><a href="#2-Receiving-Data-lt-chan" class="headerlink" title="2. Receiving Data (&lt;- chan)"></a>2. Receiving Data (&lt;- chan)</h4><ul>
<li>If the waiting sending queue (sendq) is not empty and there is no buffer, directly retrieve a Goroutine (G) from sendq,  wake up G, end the reading process.</li>
<li>If the waiting sending queue (sendq) is not empty, indicating that the buffer is full, read data from the head of the buffer, write the data from G to the end of the buffer, wake up G, and  end the reading process.</li>
<li>If there is data in the buffer, retrieve the data from the buffer and end the reading process</li>
<li>If the waiting sending queue (sendq) and buffer are empty, add the current Goroutine to recvq, enter a sleep state, and await awakening by a writing Goroutine.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Read from a closed channel is allowed **</span></span><br><span class="line">  <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.qcount == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        raceacquire(c.raceaddr())</span><br><span class="line">      &#125;</span><br><span class="line">      unlock(&amp;c.lock)</span><br><span class="line">      <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">        typedmemclr(c.elemtype, ep)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The channel has been closed, but the channel&#x27;s buffer have data.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Just found waiting sender with not closed.</span></span><br><span class="line">    <span class="keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// Found a waiting sender. If buffer is size 0, receive value</span></span><br><span class="line">      <span class="comment">// directly from sender. Otherwise, receive from head of queue</span></span><br><span class="line">      <span class="comment">// and add sender&#x27;s value to the tail of the queue (both map to</span></span><br><span class="line">      <span class="comment">// the same buffer slot because the queue is full).</span></span><br><span class="line">      recv(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ** Dequeuing from Channel Buffer **</span></span><br><span class="line">  <span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">// Receive directly from queue</span></span><br><span class="line">    qp := chanbuf(c, c.recvx)</span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">      racenotify(c, c.recvx, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">      typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">    &#125;</span><br><span class="line">    typedmemclr(c.elemtype, qp)</span><br><span class="line">    c.recvx++</span><br><span class="line">    <span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">      c.recvx = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.qcount--</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// no sender available: block on this channel.</span></span><br><span class="line">  gp := getg()</span><br><span class="line">  mysg := acquireSudog()</span><br><span class="line">  mysg.releasetime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  gp.waiting = mysg</span><br><span class="line">  gp.param = <span class="literal">nil</span></span><br><span class="line">  c.recvq.enqueue(mysg)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// someone woke us up</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>, success</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-Close-channel"><a href="#3-Close-channel" class="headerlink" title="3. Close channel"></a>3. Close channel</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">operation         | nil channel | closed channel     |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">close(ch)         | panic       | panic              |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">ch &lt;-             | blocking    | panic              |</span><br><span class="line">------------------------------------------------------</span><br><span class="line">v, ok := &lt;- ch    | blocking    | ok always be <span class="literal">false</span> |</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://go101.org/article/channel-closing.html">How to Gracefully Close Channels</a></p>
<ol>
<li>M receivers, one sender, the sender says “no more sends” by closing the data channel</li>
<li>One receiver, N senders, the only receiver says “please stop sending more” by closing an additional signal channel</li>
<li>M receivers, N senders, any one of them says “let’s end the game” by notifying a moderator to close an additional signal channel</li>
</ol>
<p>Solutions Which Close Channels Politely: Use sync.Once or a mutex (sync.Mutex) to ensure that the channel is closed only once</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyChannel <span class="keyword">struct</span> &#123;</span><br><span class="line">  C    <span class="keyword">chan</span> T</span><br><span class="line">  once sync.Once</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMyChannel</span><span class="params">()</span> *<span class="title">MyChannel</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;MyChannel&#123;C: <span class="built_in">make</span>(<span class="keyword">chan</span> T)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mc *MyChannel)</span> <span class="title">SafeClose</span><span class="params">()</span></span> &#123;</span><br><span class="line">  mc.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">close</span>(mc.C)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/20/Authentication-and-Authorization-for-SSO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/20/Authentication-and-Authorization-for-SSO/" class="post-title-link" itemprop="url">Authentication and Authorization for SSO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-12-20 23:54:06 / Modified: 23:58:30" itemprop="dateCreated datePublished" datetime="2023-12-20T23:54:06+08:00">2023-12-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Authentication-Authorization/" itemprop="url" rel="index"><span itemprop="name">Authentication, Authorization</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Authentication-and-Authorization-for-SSO"><a href="#Authentication-and-Authorization-for-SSO" class="headerlink" title="Authentication and Authorization for SSO"></a>Authentication and Authorization for SSO</h1><h2 id="OAuth-2-0-Open-Authorization-2-0"><a href="#OAuth-2-0-Open-Authorization-2-0" class="headerlink" title="OAuth 2.0 (Open Authorization 2.0):"></a>OAuth 2.0 (Open Authorization 2.0):</h2><p>  OAuth 2.0 is an <strong>authorization framework</strong> that allows third-party applications to obtain limited access to a user’s resources on a server without exposing their credentials. It’s commonly used for delegated authorization scenarios, such as allowing a third-party application to access a user’s data on another service (e.g., social media data access).<br>  If the Client is a Single-Page App (SPA), an application running in a browser using a scripting language like JavaScript, there are two grant options:</p>
<ul>
<li><p>Authorization code (front channel + back channel): safer since the Access Token is not exposed on the client side, and this flow can return Refresh Tokens.</p>
</li>
<li><p>Implicit (front channel only)</p>
<p><a target="_blank" rel="noopener" href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/which-oauth-2-0-flow-should-i-use">Which OAuth 2.0 Flow Should I Use?</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=996OiexHze0">OAuth 2.0 and OpenID Connect (in plain English)</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/59511628/is-it-secure-to-store-a-refresh-token-in-the-database-to-issue-new-access-toke">Is it secure to store a refresh token in the database?</a></p>
</li>
</ul>
<h2 id="OpenID-Connect-OIDC"><a href="#OpenID-Connect-OIDC" class="headerlink" title="OpenID Connect (OIDC):"></a>OpenID Connect (OIDC):</h2><p>  OpenID Connect is an <strong>interoperable authentication protocol based on the OAuth 2.0 framework</strong> . It provides a standardized way for clients to obtain information about the end-user in order to authenticate them. OIDC is often used for single sign-on (SSO) scenarios, where a user can log in once and access multiple applications without needing to log in again. OIDC uses JSON Web Tokens (JWT), HTTP flows and avoids sharing user credentials with services.</p>
<p>  What OpenID Connect adds</p>
<ul>
<li><p>ID token(JWT)</p>
</li>
<li><p>UserInfo endpoint for getting more user information</p>
</li>
<li><p>Standard set of scopes</p>
</li>
<li><p>Standardized implementation</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------------------</span><br><span class="line">| OpenID Connect |  -&gt; OpenID Connect is <span class="keyword">for</span> authentication</span><br><span class="line">------------------</span><br><span class="line">|    OAuth 2.0   |  -&gt; OAuth 2.0 is <span class="keyword">for</span> authorization</span><br><span class="line">------------------</span><br><span class="line">|      HTTP      |</span><br><span class="line">------------------</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://openid.net/developers/how-connect-works/">How OpenID Connect Works - OpenID Foundation</a></p>
<h2 id="JSON-Web-Tokens-JWT"><a href="#JSON-Web-Tokens-JWT" class="headerlink" title="JSON Web Tokens (JWT):"></a>JSON Web Tokens (JWT):</h2><p>JSON Web Tokens (JWT) are <strong>a format for representing claims</strong>, often used in OAuth 2.0 and OIDC as a means of transmitting information securely between parties. In OIDC, the identity token is a JWT.</p>
<p>JWTs consist of three parts:</p>
</li>
<li><p>Header: typically consists of two parts: the type of the token, which is JWT, and the signing algorithm being used, such as HMAC SHA256 or RSA.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>PlayLoad(claims): there are three types of claims: registered(<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7519#page-10">reference</a>), public(<a target="_blank" rel="noopener" href="https://www.iana.org/assignments/jwt/jwt.xhtml">reference</a>), and private(custom) claims.</p>
</li>
<li><p>Signature: used to verify the message wasn’t changed along the way</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">base64UrlEncode(payload),</span><br><span class="line">secret)</span><br></pre></td></tr></table></figure>

<p>The output is three Base64-URL strings separated by dots.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Base64[Header].Base64[Payload(claims)].Base64[Signature]</span><br></pre></td></tr></table></figure>

<p>usage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jwt.io/introduction">Introduction to JSON Web Tokens</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/16/how-to-troubleshooting-k8s-pods-and-containers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/16/how-to-troubleshooting-k8s-pods-and-containers/" class="post-title-link" itemprop="url">How to troubleshooting k8s pods and containers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-09-16 17:00:06" itemprop="dateCreated datePublished" datetime="2023-09-16T17:00:06+08:00">2023-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-23 23:54:28" itemprop="dateModified" datetime="2024-08-23T23:54:28+08:00">2024-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="How-to-troubleshooting-k8s-pods-and-containers"><a href="#How-to-troubleshooting-k8s-pods-and-containers" class="headerlink" title="How to troubleshooting k8s pods and containers"></a>How to troubleshooting k8s pods and containers</h1><h2 id="hold-on-program-by-tail-f-dev-null"><a href="#hold-on-program-by-tail-f-dev-null" class="headerlink" title="hold on program by tail -f /dev/null"></a>hold on program by <code>tail -f /dev/null</code></h2><p>The command “tail -f /dev/null” is a Unix/Linux command that is often used as a placeholder or a trick to prevent a command or a script from exiting or terminating.</p>
<p>The tail command is typically used to display the last few lines of a file. When used with the -f option, it enables “follow” mode, where tail will continuously display new lines appended to the file in real-time. However, when tail -f is used with /dev/null, which is a special file that discards all data written to it, the command essentially does nothing. /dev/null is commonly used as a bit bucket or a sink for unwanted output.</p>
<p>So, in essence, running the command “tail -f /dev/null” will cause the tail command to start and keep running indefinitely, but it won’t display any output because /dev/null discards everything written to it. It’s often used as a placeholder command to prevent scripts or programs from exiting or to keep a terminal session open without any active output.</p>
<h3 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h3><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command: [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">my-image:tag</span></span><br><span class="line">  <span class="attr">command:</span> [<span class="string">&quot;tail&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;/dev/null&quot;</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>NOTE<br>  Keep in mind that while ENTRYPOINT defines the default command in dockerfile, it can be overridden by providing commands in the Kubernetes pod. This means that if you specify a command  <code>tail -f /dev/null</code> within the pod, the container within it will be held up by the provided command, and any commands specified in the ENTRYPOINT won’t be executed.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Tina Wong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WongJY Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/" class="post-title-link" itemprop="url">Kubernetes Ingress and Services troubleshooting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-09-10 00:52:24" itemprop="dateCreated datePublished" datetime="2023-09-10T00:52:24+08:00">2023-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-23 23:50:54" itemprop="dateModified" datetime="2024-08-23T23:50:54+08:00">2024-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Ingress-and-Services-troubleshooting"><a href="#Kubernetes-Ingress-and-Services-troubleshooting" class="headerlink" title="Kubernetes Ingress and Services troubleshooting"></a>Kubernetes Ingress and Services troubleshooting</h1><ul>
<li><p>Traffic flow: Internet → Ingress controller rule (according to your Ingress YAML) → Service → Pods</p>
</li>
<li><p>Debug flow: Pods → Service → Ingress → Ingress controller → Internet</p>
</li>
</ul>
<h2 id="Check-the-Deployment-amp-Pods"><a href="#Check-the-Deployment-amp-Pods" class="headerlink" title="Check the Deployment &amp; Pods"></a>Check the Deployment &amp; Pods</h2><ol>
<li>Makes sure that the Pod is up and running (Pod’s “Status” is “Running”). If not, checks the Deployment/Pod Resource Events and log to fix the problem.</li>
<li>If you are using HTTP GET livenessProbe, ensure your Service and Ingress are deployed beforehand.</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># logs of deployment</span></span><br><span class="line">$ kubectl logs deployment/&lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># follow logs of deployment, ctrl+c to quit</span></span><br><span class="line">$ kubectl logs -f deployment/&lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"><span class="comment"># check &quot;Events&quot; at bottom of the output</span></span><br><span class="line">$ kubectl describe deployment &lt;name-of-deployment&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -n &lt;namespace&gt;</span><br><span class="line">$ kubectl logs pod/&lt;name-of-pod&gt; -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe pod &lt;name-of-pod&gt; -o wide -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Check-the-port-mapping"><a href="#Check-the-port-mapping" class="headerlink" title="Check the port mapping"></a>Check the port mapping</h2><img src="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/1.png" width="80%" height="80%" alt="1">

<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a><br>    - An Ingress may be configured to give Services externally-reachable URLs, load balance traffic, terminate SSL / TLS, and offer name-based virtual hosting. An Ingress controller is responsible for fulfilling the Ingress, usually with a load balancer, though it may also configure your edge router or additional frontends to help handle the traffic.<br>    - An Ingress does not expose arbitrary ports or protocols. Exposing services other than HTTP and HTTPS to the internet typically uses a service of type Service.Type=NodePort or Service.Type=LoadBalancer.</p>
</blockquote>
<h2 id="Check-the-Service"><a href="#Check-the-Service" class="headerlink" title="Check the Service"></a>Check the Service</h2><ol>
<li>Checks the “Endpoints” field in Service, which should match the “IP” of Pods.</li>
<li>If you are using public cloud like GKE, AKS…, you can modify the Service Types to LoadBalancer to expose your Service publicly without ingress. If this work for you, meaning that your Pods and Service work correctly, problems are cause by others.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get service -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe service &lt;name-of-pod&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Check-the-Ingress-amp-Ingress-Controller-Logs-and-Resource-Events"><a href="#Check-the-Ingress-amp-Ingress-Controller-Logs-and-Resource-Events" class="headerlink" title="Check the Ingress &amp; Ingress Controller Logs and Resource Events"></a>Check the Ingress &amp; Ingress Controller Logs and Resource Events</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a><br>    - In order for the Ingress resource to work, the cluster must have an ingress controller running.<br>    - Unlike other types of controllers which run as part of the kube-controller-manager binary, Ingress controllers are not started automatically with a cluster in public cloud like GKE, AKS…. You need to choose the ingress controller implementation that best fits your cluster.<br>    - Ingress Controller in AKS is AKS Application Gateway Ingress Controller ,which is ingress-appgw-deployment below. The ingress controller runs as a pod within the AKS cluster. It consumes Kubernetes Ingress Resources and converts them to an Azure Application Gateway configuration which allows the gateway to load-balance traffic to Kubernetes pods.</p>
</blockquote>
<ol>
<li><p>Checks your Ingress for any Event or error log</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress -n &lt;namespace&gt;</span><br><span class="line">$ kubectl describe ingress &lt;name-of-ingress&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>Checks your ingress controller configuration to see if it’s rule match the ingress you just apply.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">λ kubectl get deployment  -n kube-system</span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">ingress-appgw-deployment   1/1     1            1           48d</span><br><span class="line">...</span><br><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">azure-cni-networkmonitor-2fmfk              1/1     Running   0          7d5h</span><br><span class="line">...</span><br><span class="line">azure-ip-masq-agent-6k4rm                   1/1     Running   0          3d5h</span><br><span class="line">...</span><br><span class="line">coredns-84d976c568-pjt8q                    1/1     Running   1          86d</span><br><span class="line">...</span><br><span class="line">ingress-appgw-deployment-7b8b687b46-scvs7   1/1     Running   315        3d5h</span><br><span class="line">kube-proxy-4c6qw                            1/1     Running   0          7d5h</span><br><span class="line">...</span><br><span class="line">metrics-server-569f6547dd-j2wjz             1/1     Running   5          86d</span><br><span class="line">...</span><br><span class="line">$ kubectl describe pod ingress-appgw-deployment-7b8b687b46-scvs7 -n kube-system</span><br></pre></td></tr></table></figure>

<p> Finally figure out that the problem is caused by Ingress controller fail to convert Ingress YAML to Azure Application Gateway configuration while you update your Ingress YAML or Pod Service endpoint, including livenessProbe.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f -n kube-system ingress-appgw-deployment-7b8b687b46-scvs7 | grep --color=always -i error</span><br><span class="line">E0110 03:19:02.123462       1 requestroutingrules.go:386] A path-rule with path <span class="string">&#x27;/merchant/*&#x27;</span> already exists <span class="keyword">in</span> config <span class="keyword">for</span> BackendPool <span class="string">&#x27;/subscriptions/49fc9d19-f517-4ca5-a93e-76ed0fbd0ab1/resourceGroups/xxx/providers/Microsoft.Network/applicationGateways/aks-gw/backendAddressPools/defaultaddresspool&#x27;</span>. Duplicate path-rule with BackendPool <span class="string">&#x27;/subscriptions/49fc9d19-f517-4ca5-a93e-76ed0fbd0ab1/resourceGroups/xxx/providers/Microsoft.Network/applicationGateways/aks-gw/backendAddressPools/pool-payment-payment-svc-80-bp-80&#x27;</span> will not be applied</span><br></pre></td></tr></table></figure>
</li>
<li><p>Restart Ingress Controller</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout restart deployment &lt;your-ingress-controller-deployment&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>For AKS Application Gateway, check:<br>    - <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-probe-overview">Application Gateway health monitoring overview</a><br>    - <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/application-gateway/application-gateway-create-probe-portal">Create a custom probe for Application Gateway by using the portal</a></p>
</blockquote>
<h2 id="Reason-for-Application-Gateway-failure"><a href="#Reason-for-Application-Gateway-failure" class="headerlink" title="Reason for Application Gateway failure"></a>Reason for Application Gateway failure</h2><p>The reasons that may cause Application Gateway fail to monitor and apply Ingress configuration.</p>
<ol>
<li><p>Using HTTPS without a Secret that contains a TLS private key and certificate. If you are using let’s encrypt to automatically produce secret file with tls.crt and tls.key with kubernates.io/tls type, make sure it hasn’t block by your your AKS firewall, which will result in wrong type of Secret(Opaque).</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">cert</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">key</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>redirecting problem</p>
<p> <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42101808/ingress-gives-502-error">Ingress gives 502 error</a></p>
<p> noticing that the application must return a 200 status code at ‘/’. if your application was returning a 302 (redirect to login), which would cause the health fail. When the health check fails, the ingress resource returns 502.</p>
</li>
<li><p>Backend path rule conflict.</p>
<p> If you specify the backend-path-prefix in Ingress, make sure it did not conflict your backend resource Deployment livenessProbe path prefix.</p>
<p> Deployment</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/payment_resource/healthcheck.jsp</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">180</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p> Ingress</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-payment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">payment</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/backend-path-prefix:</span> <span class="string">/payment_resource/</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/connection-draining:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/connection-draining-timeout:</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/cookie-based-affinity:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">appgw.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">letsencrypt-production</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.allow-http:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">azure/application-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">xxx.xxx.xxx.azure.com</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">aks-ingress-cert</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">xxx.xxx.xxx.azure.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/payment/*</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">payment-svc</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p> Visit <a target="_blank" rel="noopener" href="https://xxx.xxx.xxx.azure.com/payment/healthcheck.jsp">https://xxx.xxx.xxx.azure.com/payment/healthcheck.jsp</a> , which would redirect to backend resource endpoint <a target="_blank" rel="noopener" href="https://xxx.xxx.xxx.azure.com/payment_resource/healthcheck.jsp">https://xxx.xxx.xxx.azure.com/payment_resource/healthcheck.jsp</a> .</p>
</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://azure.github.io/application-gateway-kubernetes-ingress/annotations/">Backend Path Prefix</a><br>This annotation allows the backend path specified in an ingress resource to be re-written with prefix specified in this annotation. This allows users to expose services whose endpoints are different than endpoint names used to expose a service in an ingress resource.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://stacksimplify.com/azure-aks/azure-kubernetes-service-ingress-context-path-routing/">Ingress — Context Path Based Routing</a></p>
<img src="/2023/09/10/Kubernetes-Ingress-and-Services-troubleshooting/2.png" width="80%" height="80%" alt="2">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Tina Wong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tina Wong</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
